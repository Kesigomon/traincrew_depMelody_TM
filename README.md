# Traincrew 乗降促進アプリ (Departure Melody App)

鉄道シミュレーター「Traincrew」用の乗降促進メロディー再生アプリケーションです。

---

## 目次
- [使用者向けドキュメント](#使用者向けドキュメント)
  - [概要](#概要)
  - [クイックスタート](#クイックスタート)
  - [シンプル設定 (simple.csv)](#シンプル設定-simplecsv)
  - [フル設定 (full.csv)](#フル設定-fullcsv)
  - [操作方法](#操作方法)
  - [プロファイルのカスタマイズ](#プロファイルのカスタマイズ)
  - [設定ファイル](#設定ファイル)
  - [トラブルシューティング](#トラブルシューティング)
- [開発者向けドキュメント](#開発者向けドキュメント)
  - [技術仕様](#技術仕様)
  - [プロジェクト構造](#プロジェクト構造)
  - [セットアップ](#セットアップ)
  - [開発情報](#開発情報)

---

# 使用者向けドキュメント

## 概要

このアプリケーションは、Traincrewゲーム内で某地下鉄線のように乗降促進を駅と車上で鳴らせるアプリケーションです。
デフォルトプロファイルとして、某地下鉄線の再現のための**full.csv**と、 車上での乗降促進のみの**simple.csv**があります。
他にもプロファイルを自作すれば、自由に音声を切り替えられます。

### 主要機能
- **車両モード**: 車両スピーカーから流れる乗降促進メロディーのループ再生
- **駅モード**: 駅スピーカーから流れる発車メロディーとドア締まりますアナウンスの再生
- **駅、上り下り自動判定**: APIを用いて現在停車中の駅と、列車の上り下りを自動で判定します。
- **プロファイル切り替え**: 用途に応じて音声設定を切り替え可能
- **キーボード操作対応**: キーでの操作に対応(設定で、有効無効,キー を変更可能です。)

## クイックスタート

1. Traincrew_depMelody_M.exeを起動する
2. 右クリックメニューから「設定」を開く
3. 使い方に応じてプロファイルを選択:
   - 車上の乗降促進のみ -> `simple.csv`
   - 地上の発車メロディーも使用 -> `full.csv`
4. 必要な音声ファイルを `sounds/` フォルダに配置
5. Traincrewを起動する
6. 「設定」-> 「操作設定」から「外部入出力1・2」を両方オンにする
7. シナリオを読み込む
8. ボタン押しでメロディー再生開始

## シンプル設定 (simple.csv)

**車上の乗降促進のみ**を使用する場合の設定です。地上の発車メロディーは鳴りません。

### 必要な音声ファイル

以下の3つの音声ファイル（MP3形式）を用意してください:

```
sounds/
├── vehicle/
│   ├── 乗降促進上り.mp3    # 上り列車用の乗降促進メロディー
│   └── 乗降促進下り.mp3    # 下り列車用の乗降促進メロディー
└── door/
    └── ドア車上.mp3         # 車上のドア締まりますアナウンス
```

### 設定手順

1. 上記3つの音声ファイルを指定のフォルダに配置
2. アプリケーションを起動
3. 右クリックメニュー → 「設定」
4. 「プロファイル」で `simple.csv` を選択
5. 「OK」をクリックして保存

### 操作方法

- **スペースキー長押し** または **ボタンクリック**: 乗降促進メロディーをループ再生
- **スペースキー離す** または **ボタンリリース**: メロディー停止 → ドア締まりますアナウンス再生

### 仕様

- 駅に停車していても駅の発車メロディーは鳴りません
- 常に車両モードで動作します
- 上り/下りは自動判定されます

## フル設定 (full.csv)

**車上の乗降促進と地上の発車メロディー**の両方を使用する場合の設定です。

### 必要な音声ファイル

以下の音声ファイル（MP3形式）を用意してください:

```
sounds/
├── vehicle/
│   ├── 乗降促進上り.mp3    # 上り列車用の乗降促進メロディー
│   └── 乗降促進下り.mp3    # 下り列車用の乗降促進メロディー
├── station/
│   ├── 館浜_1.mp3          # 館浜駅1番線の発車メロディー
│   ├── 館浜_2.mp3          # 館浜駅2番線の発車メロディー
│   ├── 駒野_1.mp3          # 駒野駅1番線の発車メロディー
│   └── ...                 # その他の駅・番線ごとのメロディー
└── door/
    ├── ドア車上.mp3         # 車上のドア締まりますアナウンス
    ├── ドアA線.mp3          # 駅A線（奇数番線）のドア締まります
    └── ドアB線.mp3          # 駅B線（偶数番線）のドア締まります
```

### 設定手順

1. 必要な音声ファイルを指定のフォルダに配置
2. アプリケーションを起動
3. 右クリックメニュー → 「設定」
4. 「プロファイル」で `full.csv` を選択
5. 駅定義ファイル (`stations/stations.csv`) で駅と軌道回路のマッピングを設定
6. 「OK」をクリックして保存

### 操作方法とモード切り替え

アプリケーションは自動的に**車両モード**と**駅モード**を切り替えます。

#### 車両モード（走行中・駅以外）
- **スペースキー長押し**: 乗降促進メロディーをループ再生
- **スペースキー離す**: メロディー停止 → 車上のドア締まりますアナウンス再生

#### 駅モード（駅停車中）
- **1回目のスペースキー押下**: 駅の発車メロディー再生 → 自動的に地上のドア締まりますアナウンス再生
- **2回目以降のスペースキー押下**: 車両モードと同じ動作（乗降促進メロディーのループ）
- **駅発車時**: 自動的に車両モードに戻る

### 仕様

- 駅停車判定は軌道回路情報とAPI連携により自動判定されます
- 駅名・番線は `stations/stations.csv` で定義された情報に基づきます
- 奇数番線と偶数番線で異なるドア締まりますアナウンスを再生できます
- 上り/下りは自動判定されます

## 操作方法

### 基本操作

| 操作 | 動作 |
|------|------|
| スペースキー長押し / ボタンクリック | メロディー再生開始 |
| スペースキー離す / ボタンリリース | メロディー停止 → ドア締まりますアナウンス |
| 右クリックメニュー | 設定画面を開く / アプリ終了 |

### キーボード操作の有効化

設定画面で「キーボード入力を有効にする」にチェックを入れることで、スペースキーでの操作が可能になります。

## プロファイルのカスタマイズ

プロファイルファイル（CSV形式）を編集することで、音声ファイルのマッピングをカスタマイズできます。

### プロファイルファイルの形式

プロファイルファイルは以下の5列で構成されます:

```csv
種別,駅名,番線,上下,ファイルパス
```

### 種別の種類

| 種別 | 説明 | 駅名 | 番線 | 上下 |
|------|------|------|------|------|
| `車両メロディー` | 車上の乗降促進メロディー | - | - | `上り` / `下り` |
| `車両ドア締まります` | 車上のドア締まりますアナウンス | - | - | - |
| `駅メロディー` | 地上の発車メロディー | 駅名 | 番線番号 | - |
| `駅ドア締まります` | 地上のドア締まりますアナウンス | - | - | `奇数` / `偶数` |

### カスタマイズ例

#### 例1: 車両メロディーのみ（simple.csv）

```csv
種別,駅名,番線,上下,ファイルパス
車両メロディー,,,上り,sounds/vehicle/乗降促進上り.mp3
車両メロディー,,,下り,sounds/vehicle/乗降促進下り.mp3
車両ドア締まります,,,,sounds/door/ドア車上.mp3
```

#### 例2: 駅を追加（full.csv）

```csv
種別,駅名,番線,上下,ファイルパス
車両メロディー,,,上り,sounds/vehicle/乗降促進上り.mp3
車両メロディー,,,下り,sounds/vehicle/乗降促進下り.mp3
車両ドア締まります,,,,sounds/door/ドア車上.mp3
駅メロディー,館浜,1,,sounds/station/館浜_1.mp3
駅メロディー,館浜,2,,sounds/station/館浜_2.mp3
駅ドア締まります,,,奇数,sounds/door/ドアA線.mp3
駅ドア締まります,,,偶数,sounds/door/ドアB線.mp3
```

### 新しいプロファイルの作成

1. `profiles/` フォルダに新しいCSVファイルを作成（例: `custom.csv`）
2. 上記の形式に従って音声ファイルのマッピングを記述
3. 設定画面でプロファイルを選択

## 設定ファイル

### appsettings.json

アプリケーション全体の設定を管理します。設定画面から変更できます。

| 設定項目 | 説明                     | 初期値 |
|----------|------------------------|--------|
| `CurrentProfile` | 使用するプロファイルファイルのパス      | `profiles/profile_default.csv` |
| `StationDefinition` | 駅定義ファイルのパス             | `stations/stations.csv` |
| `Volume` | 音量（0.0～1.0）            | `0.8` |
| `Topmost` | ウィンドウを最前面表示            | `Always` |
| `EnableKeyboard` | キーボード操作の有効化            | `true` |


## トラブルシューティング

### 音声ファイルが再生されない

- `sounds/` ディレクトリに音声ファイルが配置されているか確認
- プロファイルファイル内のファイルパスが正しいか確認
- ログファイル（`log/` フォルダ内）でエラーメッセージを確認
- 音量設定が0になっていないか確認

### 駅メロディーが鳴らない

- `full.csv` を選択しているか確認
- `stations/stations.csv` に駅と軌道回路が定義されているか確認
- 軌道回路名がTraincrewのマップデータと一致しているか確認
- API連携が正常に動作しているか確認（ログファイルを確認）

### プロファイルが切り替わらない

- 設定画面で「OK」ボタンをクリックしているか確認
- アプリケーションを再起動してみる
- `appsettings.json` に書き込み権限があるか確認

### キーボード操作が効かない

- 設定画面で「キーボード入力を有効にする」にチェックが入っているか確認
- アプリケーションウィンドウがアクティブになっているか確認

---

# 開発者向けドキュメント

## 技術仕様

- **フレームワーク**: .NET 8.0 + WPF
- **アーキテクチャ**: レイヤードアーキテクチャ (Infrastructure / Application / Presentation)
- **デザインパターン**: MVVM, Repository, State
- **ログ**: Microsoft.Extensions.Logging を使用したファイルログ

## プロジェクト構造

```
TraincrewDepMelody/
├── Models/                      # データモデルと列挙型
│   ├── Enums.cs
│   ├── StationInfo.cs
│   ├── ApplicationState.cs
│   └── AppSettings.cs
├── Infrastructure/              # インフラストラクチャ層
│   ├── Api/                     # API通信
│   │   ├── ITraincrewApi.cs
│   │   ├── MockTraincrewApi.cs
│   │   └── TraincrewApiClient.cs
│   ├── Repositories/            # データリポジトリ
│   │   ├── StationRepository.cs
│   │   ├── AudioRepository.cs
│   │   └── ProfileLoader.cs
│   ├── Settings/                # 設定管理
│   │   └── SettingsManager.cs
│   └── Logging/                 # ログ
│       └── FileLoggerProvider.cs
├── Application/                 # アプリケーション層
│   ├── Audio/                   # 音声再生
│   │   └── AudioPlayer.cs
│   └── Modes/                   # モード管理
│       ├── IMode.cs
│       ├── StationMode.cs
│       ├── VehicleMode.cs
│       └── ModeManager.cs
├── Presentation/                # プレゼンテーション層
│   ├── ViewModels/
│   │   └── MainViewModel.cs
│   └── Views/
│       └── SettingsWindow.xaml
├── MainWindow.xaml              # メインウィンドウ
├── appsettings.json             # アプリケーション設定
├── profiles/                    # 音声プロファイル
│   ├── simple.csv               # シンプル設定
│   └── full.csv                 # フル設定
├── stations/                    # 駅定義
│   └── stations.csv
└── sounds/                      # 音声ファイル配置場所
    ├── vehicle/
    ├── station/
    └── door/
```

## セットアップ

### 必要な環境
- .NET 8.0 SDK
- Windows 10/11 (WPF対応)

### ビルド方法

```bash
cd TraincrewDepMelody
dotnet build
```

### 実行方法

```bash
dotnet run
```

または、ビルド後の実行ファイルを直接起動:
```
TraincrewDepMelody\bin\Debug\net8.0-windows\Traincrew_depMelody_M.exe
```

## 開発情報

### stations/stations.csv

駅と軌道回路のマッピングを定義するマスタ。延進時などに更新する

```csv
駅名,番線,軌道回路1,軌道回路2,軌道回路3
館浜,1,TH76_5LAT,,
館浜,2,TH76_5LBT,,
駒野,1,TH75_5RAT,,
```

- **駅名**: プロファイルファイルの駅名と一致させる
- **番線**: 番線番号（プロファイルファイルの番線と一致）
- **軌道回路1～3**: その番線を構成する軌道回路名（Traincrewのマップデータと一致）

### 依存パッケージ
- **CsvHelper**: CSVファイルの読み込み
- **Newtonsoft.Json**: JSON設定ファイルの処理
- **Microsoft.Extensions.Logging**: ログ機能

### ログ出力
ログファイルは `log/` ディレクトリに出力されます。
ファイル名: `yyyyMMddHHmmss.txt`

### API連携
`TraincrewApi` クラスで実装済みです。
- **TrainCrewInput.dll**: ゲーム状態と列番の取得
- **WebSocket (ws://127.0.0.1:50300/)**: 軌道回路データの取得
- **モック実装**: `MockTraincrewApi` がテスト用に利用可能

### テスト

```bash
cd TraincrewDepMelody.Tests
dotnet test
```

## ライセンス
このプロジェクトは個人利用・研究目的で作成されました。

## 作成者
Claude Code による自動実装
