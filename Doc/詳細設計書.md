# 乗降促進アプリ 詳細設計書

**バージョン**: 1.0
**作成日**: 2025年10月11日
**対象システム**: Traincrew 乗降促進アプリ

---

## 1. クラス設計

### 1.1 クラス図

```
┌─────────────────────┐
│   MainWindow        │
├─────────────────────┤
│ - _viewModel        │
│ - _contextMenu      │
│ - _debugPanel       │
├─────────────────────┤
│ + OnButtonMouseDown()│
│ + OnButtonMouseUp() │
│ + ShowSettings()    │
│ + ToggleDebug()     │
└──────────┬──────────┘
           │
           │ViewModel
           ▼
┌─────────────────────┐         ┌──────────────────┐
│  MainViewModel      │◆───────│   ModeManager    │
├─────────────────────┤         ├──────────────────┤
│ - _modeManager      │         │ - _stationMode   │
│ - _applicationState │         │ - _vehicleMode   │
├─────────────────────┤         │ - _currentMode   │
│ + OnButtonPressed() │         ├──────────────────┤
│ + OnButtonReleased()│         │ + OnButtonPressed() │
│ + Update()          │         │ + OnButtonReleased()│
└─────────────────────┘         │ + SwitchMode()   │
                                │ + Update()       │
                                └────────┬─────────┘
                                         │
                        ┌────────────────┼────────────────┐
                        │                │                │
                        ▼                ▼                │
              ┌──────────────┐  ┌─────────────┐          │
              │ StationMode  │  │VehicleMode  │          │
              ├──────────────┤  ├─────────────┤          │
              │ - _isFirst   │  │ - _isLooping│          │
              │   Press      │  │             │          │
              ├──────────────┤  ├─────────────┤          │
              │ + OnButton   │  │ + OnButton  │          │
              │   Pressed()  │  │   Pressed() │          │
              │ + OnButton   │  │ + OnButton  │          │
              │   Released() │  │   Released()│          │
              └──────┬───────┘  └──────┬──────┘          │
                     │                 │                 │
                     └────────┬────────┘                 │
                              │                          │
                              │ Uses                     │
                              ▼                          │
                     ┌──────────────┐                    │
                     │ AudioPlayer  │                    │
                     ├──────────────┤                    │
                     │ - _player    │                    │
                     │ - _isLooping │                    │
                     ├──────────────┤                    │
                     │ + Play()     │                    │
                     │ + Stop()     │                    │
                     │ + Pause()    │                    │
                     │ + Resume()   │                    │
                     └──────┬───────┘                    │
                            │                            │
                            │ Gets audio from            │
                            ▼                            │
                   ┌──────────────────┐                  │
                   │ AudioRepository  │                  │
                   ├──────────────────┤                  │
                   │ - _audioFiles    │                  │
                   ├──────────────────┤                  │
                   │ + GetStation     │                  │
                   │   Melody()       │                  │
                   │ + GetVehicle     │                  │
                   │   Melody()       │                  │
                   │ + GetDoorClosing()│                 │
                   └──────────────────┘                  │
                                                         │
                   ┌─────────────────────┐               │
                   │TraincrewApiClient   │◄──────────────┘
                   ├─────────────────────┤
                   │ - _api              │
                   ├─────────────────────┤
                   │ + GetGameStatus()   │
                   │ + GetTrackCircuits()│
                   │ + GetTrainNumber()  │
                   └─────────────────────┘
```

---

## 2. 詳細クラス仕様

### 2.1 Presentation Layer

#### 2.1.1 MainWindow

```csharp
/// <summary>
/// メインウィンドウ
/// </summary>
public partial class MainWindow : Window
{
    #region フィールド
    private MainViewModel _viewModel;
    private ContextMenu _contextMenu;
    private DebugPanel _debugPanel;
    private DispatcherTimer _updateTimer;
    #endregion

    #region コンストラクタ
    public MainWindow()
    {
        InitializeComponent();

        _viewModel = new MainViewModel();
        DataContext = _viewModel;

        InitializeContextMenu();
        InitializeDebugPanel();
        InitializeTimer();

        // キーボード入力
        KeyDown += OnKeyDown;
        KeyUp += OnKeyUp;
    }
    #endregion

    #region イベントハンドラ
    /// <summary>
    /// ボタンマウスダウン
    /// </summary>
    private void OnButtonMouseDown(object sender, MouseButtonEventArgs e)
    {
        if (e.ChangedButton == MouseButton.Left)
        {
            _viewModel.OnButtonPressed();
        }
        else if (e.ChangedButton == MouseButton.Right)
        {
            _contextMenu.IsOpen = true;
            e.Handled = true;
        }
    }

    /// <summary>
    /// ボタンマウスアップ
    /// </summary>
    private void OnButtonMouseUp(object sender, MouseButtonEventArgs e)
    {
        if (e.ChangedButton == MouseButton.Left)
        {
            _viewModel.OnButtonReleased();
        }
    }

    /// <summary>
    /// キーダウン
    /// </summary>
    private void OnKeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Space && !e.IsRepeat)
        {
            _viewModel.OnButtonPressed();
        }
        else if (e.Key == Key.D &&
                 (Keyboard.Modifiers & ModifierKeys.Control) == ModifierKeys.Control &&
                 (Keyboard.Modifiers & ModifierKeys.Shift) == ModifierKeys.Shift)
        {
            ToggleDebugPanel();
        }
    }

    /// <summary>
    /// キーアップ
    /// </summary>
    private void OnKeyUp(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Space)
        {
            _viewModel.OnButtonReleased();
        }
    }

    /// <summary>
    /// 設定画面表示
    /// </summary>
    private void ShowSettings()
    {
        var settingsWindow = new SettingsWindow();
        settingsWindow.Owner = this;
        settingsWindow.ShowDialog();
    }

    /// <summary>
    /// デバッグパネル表示切替
    /// </summary>
    private void ToggleDebugPanel()
    {
        _debugPanel.Visibility = _debugPanel.Visibility == Visibility.Visible
            ? Visibility.Collapsed
            : Visibility.Visible;
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// コンテキストメニュー初期化
    /// </summary>
    private void InitializeContextMenu()
    {
        _contextMenu = new ContextMenu();

        var settingsItem = new MenuItem { Header = "設定" };
        settingsItem.Click += (s, e) => ShowSettings();

        var exitItem = new MenuItem { Header = "終了" };
        exitItem.Click += (s, e) => Application.Current.Shutdown();

        _contextMenu.Items.Add(settingsItem);
        _contextMenu.Items.Add(exitItem);
    }

    /// <summary>
    /// デバッグパネル初期化
    /// </summary>
    private void InitializeDebugPanel()
    {
        _debugPanel = new DebugPanel();
        _debugPanel.DataContext = _viewModel.ApplicationState;
        _debugPanel.Visibility = Visibility.Collapsed;

        // メインGridに追加
        MainGrid.Children.Add(_debugPanel);
    }

    /// <summary>
    /// タイマー初期化 (20ms間隔で状態更新)
    /// </summary>
    private void InitializeTimer()
    {
        _updateTimer = new DispatcherTimer
        {
            Interval = TimeSpan.FromMilliseconds(20)
        };
        _updateTimer.Tick += (s, e) => _viewModel.Update();
        _updateTimer.Start();
    }
    #endregion
}
```

#### 2.1.2 SettingsWindow

```csharp
/// <summary>
/// 設定ウィンドウ
/// </summary>
public partial class SettingsWindow : Window
{
    #region フィールド
    private SettingsViewModel _viewModel;
    #endregion

    #region コンストラクタ
    public SettingsWindow()
    {
        InitializeComponent();

        _viewModel = new SettingsViewModel();
        DataContext = _viewModel;
    }
    #endregion

    #region イベントハンドラ
    /// <summary>
    /// プロファイル選択変更
    /// </summary>
    private void OnProfileSelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        _viewModel.LoadProfile();
    }

    /// <summary>
    /// 駅定義CSV選択
    /// </summary>
    private void OnBrowseStationCsv(object sender, RoutedEventArgs e)
    {
        var dialog = new OpenFileDialog
        {
            Filter = "CSV files (*.csv)|*.csv|All files (*.*)|*.*",
            Title = "駅定義CSVを選択"
        };

        if (dialog.ShowDialog() == true)
        {
            _viewModel.StationCsvPath = dialog.FileName;
        }
    }

    /// <summary>
    /// 保存ボタン
    /// </summary>
    private void OnSaveClick(object sender, RoutedEventArgs e)
    {
        _viewModel.SaveSettings();
        Close();
    }

    /// <summary>
    /// キャンセルボタン
    /// </summary>
    private void OnCancelClick(object sender, RoutedEventArgs e)
    {
        Close();
    }
    #endregion
}
```

#### 2.1.3 DebugPanel

```csharp
/// <summary>
/// デバッグ情報パネル
/// </summary>
public partial class DebugPanel : UserControl
{
    #region プロパティ (Binding用)
    public string CurrentMode { get; set; }
    public string StationName { get; set; }
    public int? Platform { get; set; }
    public string TrainNumber { get; set; }
    public string Direction { get; set; }
    public string OccupiedTracks { get; set; }
    public string CurrentAudioFile { get; set; }
    public string ApiStatus { get; set; }
    public string GameStatus { get; set; }
    #endregion

    #region コンストラクタ
    public DebugPanel()
    {
        InitializeComponent();
    }
    #endregion
}
```

---

### 2.2 Application Layer

#### 2.2.1 MainViewModel

```csharp
/// <summary>
/// メインビューモデル
/// </summary>
public class MainViewModel : INotifyPropertyChanged
{
    #region フィールド
    private ModeManager _modeManager;
    private TopmostController _topmostController;
    private ILogger<MainViewModel> _logger;
    #endregion

    #region プロパティ
    public ApplicationState ApplicationState { get; }
    #endregion

    #region コンストラクタ
    public MainViewModel()
    {
        ApplicationState = new ApplicationState();
        _logger = ServiceLocator.GetService<ILogger<MainViewModel>>();

        // 依存関係注入
        var audioPlayer = new AudioPlayer(_logger);
        var audioRepository = ServiceLocator.GetService<AudioRepository>();
        var apiClient = ServiceLocator.GetService<TraincrewApiClient>();
        var stationRepository = ServiceLocator.GetService<StationRepository>();

        _modeManager = new ModeManager(
            audioPlayer,
            audioRepository,
            apiClient,
            stationRepository,
            ApplicationState,
            _logger
        );

        _topmostController = new TopmostController(Application.Current.MainWindow);
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// ボタン押下
    /// </summary>
    public void OnButtonPressed()
    {
        _logger.Info("Button pressed");
        _modeManager.OnButtonPressed();
    }

    /// <summary>
    /// ボタンリリース
    /// </summary>
    public void OnButtonReleased()
    {
        _logger.Info("Button released");
        _modeManager.OnButtonReleased();
    }

    /// <summary>
    /// 状態更新 (20ms間隔で呼ばれる)
    /// </summary>
    public void Update()
    {
        _modeManager.Update();
        _topmostController.Update(ApplicationState);
        OnPropertyChanged(nameof(ApplicationState));
    }
    #endregion

    #region INotifyPropertyChanged
    public event PropertyChangedEventHandler PropertyChanged;

    protected virtual void OnPropertyChanged(string propertyName)
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }
    #endregion
}
```

#### 2.2.2 ModeManager

```csharp
/// <summary>
/// モード管理クラス
/// </summary>
public class ModeManager
{
    #region フィールド
    private IMode _currentMode;
    private StationMode _stationMode;
    private VehicleMode _vehicleMode;

    private AudioPlayer _audioPlayer;
    private AudioRepository _audioRepository;
    private TraincrewApiClient _apiClient;
    private StationRepository _stationRepository;
    private ApplicationState _state;
    private ILogger<ModeManager> _logger;

    private StationInfo _previousStation;
    #endregion

    #region プロパティ
    public IMode CurrentMode => _currentMode;
    #endregion

    #region コンストラクタ
    public ModeManager(
        AudioPlayer audioPlayer,
        AudioRepository audioRepository,
        TraincrewApiClient apiClient,
        StationRepository stationRepository,
        ApplicationState state,
        ILogger<ModeManager> logger)
    {
        _audioPlayer = audioPlayer;
        _audioRepository = audioRepository;
        _apiClient = apiClient;
        _stationRepository = stationRepository;
        _state = state;
        _logger = logger;

        // モード初期化
        _stationMode = new StationMode(_audioPlayer, _audioRepository, _state, _logger);
        _vehicleMode = new VehicleMode(_audioPlayer, _audioRepository, _state, _logger);

        // 初期モードは車両モード
        _currentMode = _vehicleMode;
        _state.CurrentMode = ModeType.Vehicle;
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// ボタン押下イベント
    /// </summary>
    public void OnButtonPressed()
    {
        // 駅モード切替判定
        if (_currentMode is VehicleMode && _state.IsAtStation)
        {
            SwitchMode(_stationMode);
        }

        _currentMode.OnButtonPressed();
    }

    /// <summary>
    /// ボタンリリースイベント
    /// </summary>
    public void OnButtonReleased()
    {
        _currentMode.OnButtonReleased();
    }

    /// <summary>
    /// 状態更新
    /// </summary>
    public void Update()
    {
        // API情報取得
        try
        {
            _state.GameStatus = _apiClient.GetGameStatus();
            _state.OccupiedTracks = _apiClient.GetTrackCircuits();
            _state.TrainNumber = _apiClient.GetTrainNumber();
            _state.Direction = DetermineDirection(_state.TrainNumber);

            // 駅判定
            var currentStation = _stationRepository.FindStation(_state.OccupiedTracks);
            _state.CurrentStation = currentStation;
            _state.IsAtStation = currentStation != null;

            // 駅到着/発車検知
            DetectStationChange(currentStation);

            // ゲーム状態による音声制御
            HandleGameStatus(_state.GameStatus);

            // モード更新
            _currentMode.Update();
        }
        catch (Exception ex)
        {
            _logger.Error("Failed to update state", ex);
        }
    }

    /// <summary>
    /// モード切替
    /// </summary>
    public void SwitchMode(IMode newMode)
    {
        _logger.Info($"Mode switch: {_currentMode.GetType().Name} -> {newMode.GetType().Name}");

        _currentMode.OnExit();
        _currentMode = newMode;
        _currentMode.OnEnter();

        _state.CurrentMode = newMode is StationMode ? ModeType.Station : ModeType.Vehicle;
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// 上下線判定
    /// </summary>
    private Direction DetermineDirection(string trainNumber)
    {
        if (string.IsNullOrEmpty(trainNumber))
        {
            return Direction.Up;
        }

        // 数字部分を抽出
        var match = Regex.Match(trainNumber, @"\d+");
        if (match.Success)
        {
            var lastDigit = int.Parse(match.Value[^1].ToString());
            return lastDigit % 2 == 0 ? Direction.Up : Direction.Down;
        }

        return Direction.Up;
    }

    /// <summary>
    /// 駅到着/発車検知
    /// </summary>
    private void DetectStationChange(StationInfo currentStation)
    {
        // 駅到着
        if (currentStation != null && _previousStation == null)
        {
            _logger.Info($"Arrived at {currentStation.StationName} platform {currentStation.Platform}");
        }
        // 駅発車
        else if (currentStation == null && _previousStation != null)
        {
            _logger.Info($"Departed from {_previousStation.StationName}");

            // 駅モード中なら車両モードに切替
            if (_currentMode is StationMode)
            {
                SwitchMode(_vehicleMode);
            }
        }

        _previousStation = currentStation;
    }

    /// <summary>
    /// ゲーム状態による音声制御
    /// </summary>
    private void HandleGameStatus(GameStatus status)
    {
        switch (status)
        {
            case GameStatus.Running:
                if (_audioPlayer.IsPaused)
                {
                    _audioPlayer.Resume();
                }
                break;

            case GameStatus.Paused:
                if (_audioPlayer.IsPlaying)
                {
                    _audioPlayer.Pause();
                }
                break;

            case GameStatus.Stopped:
                _audioPlayer.StopAll();

                // 駅モード中なら車両モードに切替
                if (_currentMode is StationMode)
                {
                    SwitchMode(_vehicleMode);
                }
                break;
        }
    }
    #endregion
}
```

#### 2.2.3 IMode インターフェース

```csharp
/// <summary>
/// モードインターフェース
/// </summary>
public interface IMode
{
    void OnEnter();
    void OnExit();
    void OnButtonPressed();
    void OnButtonReleased();
    void Update();
}
```

#### 2.2.4 StationMode

```csharp
/// <summary>
/// 駅モード
/// </summary>
public class StationMode : IMode
{
    #region フィールド
    private AudioPlayer _audioPlayer;
    private AudioRepository _audioRepository;
    private ApplicationState _state;
    private ILogger<StationMode> _logger;

    private bool _isFirstPress = true;
    private PlaybackState _playbackState = PlaybackState.Idle;
    #endregion

    #region コンストラクタ
    public StationMode(
        AudioPlayer audioPlayer,
        AudioRepository audioRepository,
        ApplicationState state,
        ILogger<StationMode> logger)
    {
        _audioPlayer = audioPlayer;
        _audioRepository = audioRepository;
        _state = state;
        _logger = logger;

        // 再生終了イベント登録
        _audioPlayer.PlaybackFinished += OnPlaybackFinished;
    }
    #endregion

    #region IMode実装
    public void OnEnter()
    {
        _logger.Info("Enter StationMode");
        _isFirstPress = true;
        _playbackState = PlaybackState.Idle;
    }

    public void OnExit()
    {
        _logger.Info("Exit StationMode");
        _audioPlayer.StopAll();
        _playbackState = PlaybackState.Idle;
    }

    public void OnButtonPressed()
    {
        if (_isFirstPress)
        {
            _logger.Info("StationMode: First button press");
            _isFirstPress = false;

            // 駅メロディー再生
            PlayStationMelody();
        }
        else
        {
            // 2回目以降の押下は車両モードの動作
            _logger.Info("StationMode: Additional button press (vehicle mode behavior)");

            // 車両チャンネルのアナウンス再生中なら停止
            if (_playbackState == PlaybackState.PlayingAnnouncement)
            {
                _audioPlayer.Stop("vehicle");
            }

            // 車両メロディーをループ再生
            PlayVehicleMelody();
        }
    }

    public void OnButtonReleased()
    {
        // 駅モードではリリースを無視 (初回のみ)
        // 2回目以降は車両モードの動作
        if (!_isFirstPress && _playbackState == PlaybackState.PlayingMelodyLoop)
        {
            _audioPlayer.Stop("vehicle");
            PlayVehicleDoorClosing();
        }
    }

    public void Update()
    {
        // 特になし
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// 駅メロディー再生
    /// </summary>
    private void PlayStationMelody()
    {
        var station = _state.CurrentStation;
        if (station == null)
        {
            _logger.Warn("Station info not available");
            return;
        }

        var melodyPath = _audioRepository.GetStationMelody(station.StationName, station.Platform);

        _logger.Info($"Playing station melody: {melodyPath}");
        _audioPlayer.Play("station", melodyPath, loop: false);
        _playbackState = PlaybackState.PlayingMelody;
    }

    /// <summary>
    /// 駅ドア締まりますアナウンス再生
    /// </summary>
    private void PlayStationDoorClosing()
    {
        var station = _state.CurrentStation;
        if (station == null)
        {
            _logger.Warn("Station info not available");
            return;
        }

        var announcementPath = _audioRepository.GetStationDoorClosing(station.IsOddPlatform);

        _logger.Info($"Playing station door closing: {announcementPath}");
        _audioPlayer.Play("station", announcementPath, loop: false);
        _playbackState = PlaybackState.PlayingAnnouncement;
    }

    /// <summary>
    /// 車両メロディー再生
    /// </summary>
    private void PlayVehicleMelody()
    {
        var melodyPath = _audioRepository.GetVehicleMelody(_state.Direction);

        _logger.Info($"Playing vehicle melody: {melodyPath}");
        _audioPlayer.Play("vehicle", melodyPath, loop: true);
        _playbackState = PlaybackState.PlayingMelodyLoop;
    }

    /// <summary>
    /// 車両ドア締まりますアナウンス再生
    /// </summary>
    private void PlayVehicleDoorClosing()
    {
        var announcementPath = _audioRepository.GetVehicleDoorClosing();

        _logger.Info($"Playing vehicle door closing: {announcementPath}");
        _audioPlayer.Play("vehicle", announcementPath, loop: false);
        _playbackState = PlaybackState.PlayingAnnouncement;
    }

    /// <summary>
    /// 再生終了イベント
    /// </summary>
    private void OnPlaybackFinished(object sender, EventArgs e)
    {
        if (_playbackState == PlaybackState.PlayingMelody)
        {
            // メロディー終了 → ドア締まりますへ
            PlayStationDoorClosing();
        }
        else if (_playbackState == PlaybackState.PlayingAnnouncement)
        {
            // アナウンス終了 → 待機
            _playbackState = PlaybackState.Idle;
        }
    }
    #endregion

    #region 内部列挙型
    private enum PlaybackState
    {
        Idle,
        PlayingMelody,
        PlayingMelodyLoop,
        PlayingAnnouncement
    }
    #endregion
}
```

#### 2.2.5 VehicleMode

```csharp
/// <summary>
/// 車両モード
/// </summary>
public class VehicleMode : IMode
{
    #region フィールド
    private AudioPlayer _audioPlayer;
    private AudioRepository _audioRepository;
    private ApplicationState _state;
    private ILogger<VehicleMode> _logger;

    private PlaybackState _playbackState = PlaybackState.Idle;
    #endregion

    #region コンストラクタ
    public VehicleMode(
        AudioPlayer audioPlayer,
        AudioRepository audioRepository,
        ApplicationState state,
        ILogger<VehicleMode> logger)
    {
        _audioPlayer = audioPlayer;
        _audioRepository = audioRepository;
        _state = state;
        _logger = logger;
    }
    #endregion

    #region IMode実装
    public void OnEnter()
    {
        _logger.Info("Enter VehicleMode");
        _playbackState = PlaybackState.Idle;
    }

    public void OnExit()
    {
        _logger.Info("Exit VehicleMode");
        _audioPlayer.Stop("vehicle");
        _playbackState = PlaybackState.Idle;
    }

    public void OnButtonPressed()
    {
        _logger.Info("VehicleMode: Button pressed");

        // アナウンス再生中なら即停止
        if (_playbackState == PlaybackState.PlayingAnnouncement)
        {
            _audioPlayer.Stop("vehicle");
        }

        // メロディーループ再生
        PlayMelodyLoop();
    }

    public void OnButtonReleased()
    {
        _logger.Info("VehicleMode: Button released");

        if (_playbackState == PlaybackState.PlayingMelodyLoop)
        {
            _audioPlayer.Stop("vehicle");
            PlayDoorClosing();
        }
    }

    public void Update()
    {
        // アナウンス再生完了チェック
        if (_playbackState == PlaybackState.PlayingAnnouncement && !_audioPlayer.IsChannelPlaying("vehicle"))
        {
            _playbackState = PlaybackState.Idle;
        }
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// メロディーループ再生
    /// </summary>
    private void PlayMelodyLoop()
    {
        var melodyPath = _audioRepository.GetVehicleMelody(_state.Direction);

        _logger.Info($"Playing vehicle melody loop: {melodyPath}");
        _audioPlayer.Play("vehicle", melodyPath, loop: true);
        _playbackState = PlaybackState.PlayingMelodyLoop;
    }

    /// <summary>
    /// ドア締まりますアナウンス再生
    /// </summary>
    private void PlayDoorClosing()
    {
        var announcementPath = _audioRepository.GetVehicleDoorClosing();

        _logger.Info($"Playing door closing: {announcementPath}");
        _audioPlayer.Play("vehicle", announcementPath, loop: false);
        _playbackState = PlaybackState.PlayingAnnouncement;
    }
    #endregion

    #region 内部列挙型
    private enum PlaybackState
    {
        Idle,
        PlayingMelodyLoop,
        PlayingAnnouncement
    }
    #endregion
}
```

#### 2.2.6 AudioPlayer

```csharp
/// <summary>
/// 音声再生クラス（複数MediaPlayerインスタンスを管理）
/// </summary>
public class AudioPlayer : IDisposable
{
    #region フィールド
    private Dictionary<string, AudioChannel> _channels;
    private ILogger<AudioPlayer> _logger;
    private double _volume = 0.8;
    #endregion

    #region プロパティ
    public bool IsPlaying => _channels.Values.Any(ch => ch.IsPlaying);
    public bool IsPaused => _channels.Values.Any(ch => ch.IsPaused);
    public string CurrentFile => _channels.Values.FirstOrDefault(ch => ch.IsPlaying)?.CurrentFile;
    #endregion

    #region イベント
    public event EventHandler PlaybackFinished;
    #endregion

    #region コンストラクタ
    public AudioPlayer(ILogger<AudioPlayer> logger)
    {
        _logger = logger;
        _channels = new Dictionary<string, AudioChannel>();
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// 音声再生（チャンネル指定）
    /// </summary>
    /// <param name="channelId">チャンネルID（例: "station", "vehicle"）</param>
    /// <param name="filePath">音声ファイルパス</param>
    /// <param name="loop">ループ再生するか</param>
    public void Play(string channelId, string filePath, bool loop = false)
    {
        try
        {
            if (!File.Exists(filePath))
            {
                _logger.Error($"Audio file not found: {filePath}");
                return;
            }

            // チャンネルが存在しない場合は作成
            if (!_channels.ContainsKey(channelId))
            {
                _channels[channelId] = new AudioChannel(_logger, _volume);
                _channels[channelId].PlaybackFinished += (s, e) => OnChannelPlaybackFinished(channelId);
            }

            var channel = _channels[channelId];
            channel.Play(filePath, loop);

            _logger.Info($"Playing on channel '{channelId}': {Path.GetFileName(filePath)} (Loop: {loop})");
        }
        catch (Exception ex)
        {
            _logger.Error($"Failed to play audio on channel '{channelId}': {filePath}", ex);
        }
    }

    /// <summary>
    /// 停止（チャンネル指定）
    /// </summary>
    public void Stop(string channelId)
    {
        if (_channels.TryGetValue(channelId, out var channel))
        {
            channel.Stop();
            _logger.Info($"Stopped channel '{channelId}'");
        }
    }

    /// <summary>
    /// 全チャンネル停止
    /// </summary>
    public void StopAll()
    {
        foreach (var (channelId, channel) in _channels)
        {
            channel.Stop();
        }
        _logger.Info("Stopped all channels");
    }

    /// <summary>
    /// 一時停止（全チャンネル）
    /// </summary>
    public void Pause()
    {
        foreach (var channel in _channels.Values)
        {
            channel.Pause();
        }
        _logger.Info("Paused all channels");
    }

    /// <summary>
    /// 再開（全チャンネル）
    /// </summary>
    public void Resume()
    {
        foreach (var channel in _channels.Values)
        {
            channel.Resume();
        }
        _logger.Info("Resumed all channels");
    }

    /// <summary>
    /// 音量設定 (0.0 ~ 1.0)
    /// </summary>
    public void SetVolume(double volume)
    {
        _volume = Math.Clamp(volume, 0.0, 1.0);

        foreach (var channel in _channels.Values)
        {
            channel.SetVolume(_volume);
        }

        _logger.Info($"Volume set to {_volume:F2}");
    }

    /// <summary>
    /// チャンネルが再生中かチェック
    /// </summary>
    public bool IsChannelPlaying(string channelId)
    {
        return _channels.TryGetValue(channelId, out var channel) && channel.IsPlaying;
    }

    /// <summary>
    /// リソース解放
    /// </summary>
    public void Dispose()
    {
        foreach (var channel in _channels.Values)
        {
            channel.Dispose();
        }
        _channels.Clear();
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// チャンネル再生終了イベント
    /// </summary>
    private void OnChannelPlaybackFinished(string channelId)
    {
        _logger.Info($"Playback finished on channel '{channelId}'");
        PlaybackFinished?.Invoke(this, EventArgs.Empty);
    }
    #endregion
}

/// <summary>
/// 音声チャンネル（個別のMediaPlayerを管理）
/// </summary>
internal class AudioChannel : IDisposable
{
    private MediaPlayer _player;
    private ILogger<AudioPlayer> _logger;
    private bool _isLooping;
    private string _currentFile;
    private bool _isPaused;

    public bool IsPlaying { get; private set; }
    public bool IsPaused => _isPaused;
    public string CurrentFile => _currentFile;

    public event EventHandler PlaybackFinished;

    public AudioChannel(ILogger<AudioPlayer> logger, double volume)
    {
        _logger = logger;
        _player = new MediaPlayer();
        _player.Volume = volume;
        _player.MediaEnded += OnMediaEnded;
        _player.MediaFailed += OnMediaFailed;
    }

    public void Play(string filePath, bool loop)
    {
        Stop();

        _player.Open(new Uri(filePath, UriKind.Absolute));
        _player.Play();

        _currentFile = filePath;
        _isLooping = loop;
        _isPaused = false;
        IsPlaying = true;
    }

    public void Stop()
    {
        _player.Stop();
        _player.Close();
        _currentFile = null;
        _isLooping = false;
        _isPaused = false;
        IsPlaying = false;
    }

    public void Pause()
    {
        if (IsPlaying && !_isPaused)
        {
            _player.Pause();
            _isPaused = true;
        }
    }

    public void Resume()
    {
        if (_isPaused)
        {
            _player.Play();
            _isPaused = false;
        }
    }

    public void SetVolume(double volume)
    {
        _player.Volume = volume;
    }

    public void Dispose()
    {
        Stop();
        _player?.Close();
    }

    private void OnMediaEnded(object sender, EventArgs e)
    {
        if (_isLooping)
        {
            _player.Position = TimeSpan.Zero;
            _player.Play();
        }
        else
        {
            IsPlaying = false;
            PlaybackFinished?.Invoke(this, EventArgs.Empty);
        }
    }

    private void OnMediaFailed(object sender, ExceptionEventArgs e)
    {
        _logger.Error($"Media playback failed: {_currentFile}", e.ErrorException);
        IsPlaying = false;
    }
}
```

---

### 2.3 Infrastructure Layer

#### 2.3.1 TraincrewApiClient

```csharp
/// <summary>
/// Traincrew API クライアント
/// </summary>
public class TraincrewApiClient
{
    #region フィールド
    private ILogger<TraincrewApiClient> _logger;
    // DLL/WebSocket実装は別途提供
    #endregion

    #region コンストラクタ
    public TraincrewApiClient(ILogger<TraincrewApiClient> logger)
    {
        _logger = logger;
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// ゲーム状態取得
    /// </summary>
    /// <returns>ゲーム状態</returns>
    public GameStatus GetGameStatus()
    {
        // 実装は別途提供されるDLL/WebSocketを使用
        throw new NotImplementedException();
    }

    /// <summary>
    /// 在線軌道回路リスト取得
    /// </summary>
    /// <returns>軌道回路ID一覧</returns>
    public List<string> GetTrackCircuits()
    {
        // 実装は別途提供されるDLL/WebSocketを使用
        throw new NotImplementedException();
    }

    /// <summary>
    /// 列番取得
    /// </summary>
    /// <returns>列番</returns>
    public string GetTrainNumber()
    {
        // 実装は別途提供されるDLL/WebSocketを使用
        throw new NotImplementedException();
    }

    /// <summary>
    /// API接続状態確認
    /// </summary>
    /// <returns>true: 接続中, false: 未接続</returns>
    public bool IsConnected()
    {
        // 実装は別途提供されるDLL/WebSocketを使用
        throw new NotImplementedException();
    }
    #endregion
}
```

#### 2.3.2 StationRepository

```csharp
/// <summary>
/// 駅・番線リポジトリ
/// </summary>
public class StationRepository
{
    #region フィールド
    private Dictionary<StationPlatform, HashSet<string>> _stationTracks;
    private ILogger<StationRepository> _logger;
    #endregion

    #region コンストラクタ
    public StationRepository(ILogger<StationRepository> logger)
    {
        _logger = logger;
        _stationTracks = new Dictionary<StationPlatform, HashSet<string>>();
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// CSVから駅定義読み込み
    /// </summary>
    public void LoadFromCsv(string filePath)
    {
        try
        {
            _logger.Info($"Loading station definition: {filePath}");

            _stationTracks.Clear();

            using var reader = new StreamReader(filePath, Encoding.UTF8);
            using var csv = new CsvReader(reader, CultureInfo.InvariantCulture);

            csv.Read();
            csv.ReadHeader();

            while (csv.Read())
            {
                var stationName = csv.GetField<string>("駅名");
                var platform = csv.GetField<int>("番線");

                var tracks = new HashSet<string>();

                // 軌道回路列を可変長で読み込み
                for (int i = 1; ; i++)
                {
                    var columnName = $"軌道回路{i}";

                    if (!csv.Context.Reader.HeaderRecord.Contains(columnName))
                    {
                        break;
                    }

                    var track = csv.GetField<string>(columnName);

                    if (!string.IsNullOrWhiteSpace(track))
                    {
                        tracks.Add(track);
                    }
                }

                var key = new StationPlatform
                {
                    StationName = stationName,
                    Platform = platform
                };

                _stationTracks[key] = tracks;

                _logger.Info($"  {stationName} {platform}番線: {string.Join(", ", tracks)}");
            }

            _logger.Info($"Loaded {_stationTracks.Count} station platforms");
        }
        catch (Exception ex)
        {
            _logger.Error($"Failed to load station definition: {filePath}", ex);
            throw;
        }
    }

    /// <summary>
    /// 在線駅判定
    /// </summary>
    public StationInfo FindStation(List<string> occupiedTracks)
    {
        if (occupiedTracks == null || occupiedTracks.Count == 0)
        {
            return null;
        }

        var occupiedSet = new HashSet<string>(occupiedTracks);

        foreach (var (stationPlatform, trackSet) in _stationTracks)
        {
            if (occupiedSet.SetEquals(trackSet))
            {
                return new StationInfo
                {
                    StationName = stationPlatform.StationName,
                    Platform = stationPlatform.Platform
                };
            }
        }

        return null;
    }

    /// <summary>
    /// 駅在線判定
    /// </summary>
    public bool IsAtStation(List<string> occupiedTracks)
    {
        return FindStation(occupiedTracks) != null;
    }
    #endregion
}
```

#### 2.3.3 AudioRepository

```csharp
/// <summary>
/// 音声ファイルリポジトリ
/// </summary>
public class AudioRepository
{
    #region フィールド
    private Dictionary<AudioKey, string> _audioFiles;
    private ILogger<AudioRepository> _logger;
    #endregion

    #region コンストラクタ
    public AudioRepository(ILogger<AudioRepository> logger)
    {
        _logger = logger;
        _audioFiles = new Dictionary<AudioKey, string>();
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// プロファイル読み込み
    /// </summary>
    public void LoadProfile(string profileCsvPath)
    {
        try
        {
            _logger.Info($"Loading audio profile: {profileCsvPath}");

            var loader = new ProfileLoader(_logger);
            _audioFiles = loader.LoadFromCsv(profileCsvPath);

            // バリデーション
            var validation = loader.Validate(_audioFiles);

            if (!validation.IsValid)
            {
                var errorMessage = GenerateValidationErrorMessage(validation);
                _logger.Error(errorMessage);
                throw new InvalidOperationException(errorMessage);
            }

            _logger.Info($"Loaded {_audioFiles.Count} audio entries");
        }
        catch (Exception ex)
        {
            _logger.Error($"Failed to load profile: {profileCsvPath}", ex);
            throw;
        }
    }

    /// <summary>
    /// 駅メロディー取得
    /// </summary>
    public string GetStationMelody(string stationName, int platform)
    {
        var key = new AudioKey
        {
            Type = AudioType.StationMelody,
            StationName = stationName,
            Platform = platform
        };

        if (_audioFiles.TryGetValue(key, out var path))
        {
            return path;
        }

        // フォールバック: 車両メロディーを使用
        _logger.Warn($"Station melody not found: {stationName} {platform}番線 (using vehicle melody as fallback)");

        // 上下線判定は呼び出し側で行う
        // ここでは上りをデフォルトとする
        return GetVehicleMelody(Direction.Up);
    }

    /// <summary>
    /// 駅ドア締まりますアナウンス取得
    /// </summary>
    public string GetStationDoorClosing(bool isOddPlatform)
    {
        var key = new AudioKey
        {
            Type = AudioType.StationDoorClosing,
            IsOdd = isOddPlatform
        };

        if (_audioFiles.TryGetValue(key, out var path))
        {
            return path;
        }

        // フォールバック: 車両ドア締まりますを使用
        _logger.Warn($"Station door closing not found: {(isOddPlatform ? "奇数" : "偶数")}番線 (using vehicle door closing as fallback)");
        return GetVehicleDoorClosing();
    }

    /// <summary>
    /// 車両メロディー取得
    /// </summary>
    public string GetVehicleMelody(Direction direction)
    {
        var key = new AudioKey
        {
            Type = AudioType.VehicleMelody,
            Direction = direction
        };

        if (_audioFiles.TryGetValue(key, out var path))
        {
            return path;
        }

        _logger.Error($"Vehicle melody not found: {direction}");
        throw new FileNotFoundException($"Required vehicle melody not found: {direction}");
    }

    /// <summary>
    /// 車両ドア締まりますアナウンス取得
    /// </summary>
    public string GetVehicleDoorClosing()
    {
        var key = new AudioKey
        {
            Type = AudioType.VehicleDoorClosing
        };

        if (_audioFiles.TryGetValue(key, out var path))
        {
            return path;
        }

        _logger.Error("Vehicle door closing not found");
        throw new FileNotFoundException("Required vehicle door closing not found");
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// 検証エラーメッセージ生成
    /// </summary>
    private string GenerateValidationErrorMessage(ValidationResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine("エラー: プロファイルの読み込みに失敗しました");
        sb.AppendLine();

        if (result.MissingEntries.Any())
        {
            sb.AppendLine("必須エントリー不足:");
            foreach (var entry in result.MissingEntries)
            {
                sb.AppendLine($"- {entry}");
            }
            sb.AppendLine();
        }

        if (result.MissingFiles.Any())
        {
            sb.AppendLine("ファイルが見つかりません:");
            foreach (var file in result.MissingFiles)
            {
                sb.AppendLine($"- {file}");
            }
            sb.AppendLine();
        }

        sb.AppendLine("プロファイルを修正してから再度読み込んでください。");

        return sb.ToString();
    }
    #endregion
}
```

#### 2.3.4 ProfileLoader

```csharp
/// <summary>
/// プロファイルローダー
/// </summary>
public class ProfileLoader
{
    #region フィールド
    private ILogger<ProfileLoader> _logger;
    #endregion

    #region コンストラクタ
    public ProfileLoader(ILogger<ProfileLoader> logger)
    {
        _logger = logger;
    }
    #endregion

    #region パブリックメソッド
    /// <summary>
    /// CSVから読み込み
    /// </summary>
    public Dictionary<AudioKey, string> LoadFromCsv(string csvPath)
    {
        var audioFiles = new Dictionary<AudioKey, string>();

        using var reader = new StreamReader(csvPath, Encoding.UTF8);
        using var csv = new CsvReader(reader, CultureInfo.InvariantCulture);

        csv.Read();
        csv.ReadHeader();

        while (csv.Read())
        {
            var type = csv.GetField<string>("種別");
            var stationName = csv.GetField<string>("駅名");
            var platform = csv.GetField<string>("番線");
            var directionOrParity = csv.GetField<string>("上下");
            var filePath = csv.GetField<string>("ファイルパス");

            var key = CreateAudioKey(type, stationName, platform, directionOrParity);
            audioFiles[key] = filePath;

            _logger.Info($"  {type}: {filePath}");
        }

        return audioFiles;
    }

    /// <summary>
    /// バリデーション
    /// </summary>
    public ValidationResult Validate(Dictionary<AudioKey, string> audioFiles)
    {
        var result = new ValidationResult
        {
            IsValid = true,
            MissingEntries = new List<string>(),
            MissingFiles = new List<string>()
        };

        // 必須エントリーチェック
        var requiredEntries = GetRequiredEntries();

        foreach (var entry in requiredEntries)
        {
            if (!audioFiles.ContainsKey(entry))
            {
                result.IsValid = false;
                result.MissingEntries.Add(entry.ToString());
            }
        }

        // ファイル存在チェック
        foreach (var (key, filePath) in audioFiles)
        {
            if (!File.Exists(filePath))
            {
                result.IsValid = false;
                result.MissingFiles.Add(filePath);
            }
        }

        return result;
    }
    #endregion

    #region プライベートメソッド
    /// <summary>
    /// AudioKey作成
    /// </summary>
    private AudioKey CreateAudioKey(string type, string stationName, string platform, string directionOrParity)
    {
        var key = new AudioKey();

        switch (type)
        {
            case "駅メロディー":
                key.Type = AudioType.StationMelody;
                key.StationName = stationName;
                key.Platform = int.Parse(platform);
                break;

            case "駅ドア締まります":
                key.Type = AudioType.StationDoorClosing;
                key.IsOdd = directionOrParity == "奇数";
                break;

            case "車両メロディー":
                key.Type = AudioType.VehicleMelody;
                key.Direction = directionOrParity == "上り" ? Direction.Up : Direction.Down;
                break;

            case "車両ドア締まります":
                key.Type = AudioType.VehicleDoorClosing;
                break;
        }

        return key;
    }

    /// <summary>
    /// 必須エントリー一覧取得
    /// </summary>
    private List<AudioKey> GetRequiredEntries()
    {
        return new List<AudioKey>
        {
            new AudioKey { Type = AudioType.VehicleMelody, Direction = Direction.Up },
            new AudioKey { Type = AudioType.VehicleMelody, Direction = Direction.Down },
            new AudioKey { Type = AudioType.VehicleDoorClosing }
        };
    }
    #endregion
}
```

---

## 3. データモデル

### 3.1 ApplicationState

```csharp
/// <summary>
/// アプリケーション状態
/// </summary>
public class ApplicationState : INotifyPropertyChanged
{
    private ModeType _currentMode;
    private GameStatus _gameStatus;
    private List<string> _occupiedTracks;
    private string _trainNumber;
    private Direction _direction;
    private StationInfo _currentStation;
    private bool _isAtStation;
    private string _currentAudioFile;
    private bool _isAudioPlaying;

    public ModeType CurrentMode
    {
        get => _currentMode;
        set { _currentMode = value; OnPropertyChanged(); }
    }

    public GameStatus GameStatus
    {
        get => _gameStatus;
        set { _gameStatus = value; OnPropertyChanged(); }
    }

    public List<string> OccupiedTracks
    {
        get => _occupiedTracks;
        set { _occupiedTracks = value; OnPropertyChanged(); }
    }

    public string TrainNumber
    {
        get => _trainNumber;
        set { _trainNumber = value; OnPropertyChanged(); }
    }

    public Direction Direction
    {
        get => _direction;
        set { _direction = value; OnPropertyChanged(); }
    }

    public StationInfo CurrentStation
    {
        get => _currentStation;
        set { _currentStation = value; OnPropertyChanged(); }
    }

    public bool IsAtStation
    {
        get => _isAtStation;
        set { _isAtStation = value; OnPropertyChanged(); }
    }

    public string CurrentAudioFile
    {
        get => _currentAudioFile;
        set { _currentAudioFile = value; OnPropertyChanged(); }
    }

    public bool IsAudioPlaying
    {
        get => _isAudioPlaying;
        set { _isAudioPlaying = value; OnPropertyChanged(); }
    }

    public event PropertyChangedEventHandler PropertyChanged;

    protected void OnPropertyChanged([CallerMemberName] string propertyName = null)
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
    }
}
```

### 3.2 AudioKey

```csharp
/// <summary>
/// 音声ファイル キー
/// </summary>
public class AudioKey : IEquatable<AudioKey>
{
    public AudioType Type { get; set; }
    public string StationName { get; set; }
    public int? Platform { get; set; }
    public bool? IsOdd { get; set; }
    public Direction? Direction { get; set; }

    public override int GetHashCode()
    {
        return HashCode.Combine(Type, StationName, Platform, IsOdd, Direction);
    }

    public bool Equals(AudioKey other)
    {
        if (other == null) return false;

        return Type == other.Type &&
               StationName == other.StationName &&
               Platform == other.Platform &&
               IsOdd == other.IsOdd &&
               Direction == other.Direction;
    }

    public override bool Equals(object obj)
    {
        return Equals(obj as AudioKey);
    }

    public override string ToString()
    {
        return Type switch
        {
            AudioType.StationMelody => $"駅メロディー({StationName} {Platform}番線)",
            AudioType.StationDoorClosing => $"駅ドア締まります({(IsOdd == true ? "奇数" : "偶数")})",
            AudioType.VehicleMelody => $"車両メロディー({Direction})",
            AudioType.VehicleDoorClosing => "車両ドア締まります",
            _ => "Unknown"
        };
    }
}
```

### 3.3 StationInfo

```csharp
/// <summary>
/// 駅情報
/// </summary>
public class StationInfo
{
    public string StationName { get; set; }
    public int Platform { get; set; }
    public bool IsOddPlatform => Platform % 2 == 1;

    public override string ToString()
    {
        return $"{StationName} {Platform}番線";
    }
}
```

### 3.4 StationPlatform

```csharp
/// <summary>
/// 駅・番線キー
/// </summary>
public class StationPlatform : IEquatable<StationPlatform>
{
    public string StationName { get; set; }
    public int Platform { get; set; }

    public override int GetHashCode()
    {
        return HashCode.Combine(StationName, Platform);
    }

    public bool Equals(StationPlatform other)
    {
        if (other == null) return false;
        return StationName == other.StationName && Platform == other.Platform;
    }

    public override bool Equals(object obj)
    {
        return Equals(obj as StationPlatform);
    }
}
```

### 3.5 列挙型

```csharp
/// <summary>
/// モード種別
/// </summary>
public enum ModeType
{
    Station,
    Vehicle
}

/// <summary>
/// ゲーム状態
/// </summary>
public enum GameStatus
{
    Running,
    Paused,
    Stopped
}

/// <summary>
/// 音声種別
/// </summary>
public enum AudioType
{
    StationMelody,
    StationDoorClosing,
    VehicleMelody,
    VehicleDoorClosing
}

/// <summary>
/// 方向
/// </summary>
public enum Direction
{
    Up,    // 上り (偶数列番)
    Down   // 下り (奇数列番)
}

/// <summary>
/// Topmostモード
/// </summary>
public enum TopmostMode
{
    Always,
    PlayingOnly,
    AtStationOnly,
    None
}
```

---

## 4. シーケンス図

### 4.1 駅モード シーケンス

```
User      MainWindow    ModeManager    StationMode    AudioPlayer    AudioRepository
 │              │             │             │              │                │
 │─ボタン押下──→│             │             │              │                │
 │              │─OnButton    │             │              │                │
 │              │  Pressed()─→│             │              │                │
 │              │             │─駅判定      │              │                │
 │              │             │─Switch      │              │                │
 │              │             │  Mode()────→│              │                │
 │              │             │             │─OnEnter()    │                │
 │              │             │             │              │                │
 │              │             │             │─GetStation   │                │
 │              │             │             │  Melody()───→│                │
 │              │             │             │◄─────────────│                │
 │              │             │             │              │                │
 │              │             │             │─Play()──────→│                │
 │              │             │             │              │                │
 │              │             │             │              │ (メロディー再生中)
 │              │             │             │◄─Finished────│                │
 │              │             │             │              │                │
 │              │             │             │─GetStation   │                │
 │              │             │             │  DoorClosing()→              │
 │              │             │             │◄─────────────│                │
 │              │             │             │              │                │
 │              │             │             │─Play()──────→│                │
 │              │             │             │              │                │
 │              │             │             │              │ (アナウンス再生中)
 │              │             │             │◄─Finished────│                │
 │              │             │             │              │                │
```

### 4.2 車両モード シーケンス

```
User      MainWindow    ModeManager    VehicleMode    AudioPlayer    AudioRepository
 │              │             │             │              │                │
 │─ボタン押下──→│             │             │              │                │
 │              │─OnButton    │             │              │                │
 │              │  Pressed()─→│             │              │                │
 │              │             │─OnButton    │              │                │
 │              │             │  Pressed()─→│              │                │
 │              │             │             │─GetVehicle   │                │
 │              │             │             │  Melody()───→│                │
 │              │             │             │◄─────────────│                │
 │              │             │             │              │                │
 │              │             │             │─Play(loop)──→│                │
 │              │             │             │              │                │
 │              │             │             │              │ (ループ再生中)
 │              │             │             │              │                │
 │─ボタンリリース→│             │             │              │                │
 │              │─OnButton    │             │              │                │
 │              │  Released()→│             │              │                │
 │              │             │─OnButton    │              │                │
 │              │             │  Released()→│              │                │
 │              │             │             │─Stop()──────→│                │
 │              │             │             │              │                │
 │              │             │             │─GetVehicle   │                │
 │              │             │             │  DoorClosing()→              │
 │              │             │             │◄─────────────│                │
 │              │             │             │              │                │
 │              │             │             │─Play()──────→│                │
 │              │             │             │              │                │
 │              │             │             │              │ (アナウンス再生中)
```

### 4.3 API状態監視 シーケンス

```
Timer     ModeManager    TraincrewApi    StationRepository    AudioPlayer
 │             │              │                  │                  │
 │─20ms───────→│              │                  │                  │
 │             │─FetchData() (API通信実行)        │                  │
 │             │─────────────→│                  │                  │
 │             │◄─────────────│                  │                  │
 │             │              │                  │                  │
 │             │─GetGameStatus() (保持した値)     │                  │
 │             │─────────────→│                  │                  │
 │             │◄─────────────│                  │                  │
 │             │              │                  │                  │
 │             │─GetTrackCircuits() (保持した値) │                  │
 │             │─────────────→│                  │                  │
 │             │◄─────────────│                  │                  │
 │             │              │                  │                  │
 │             │─GetTrainNumber() (保持した値)    │                  │
 │             │─────────────→│                  │                  │
 │             │◄─────────────│                  │                  │
 │             │              │                  │                  │
 │             │─FindStation()                   │                  │
 │             │──────────────────────────────→  │                  │
 │             │◄──────────────────────────────  │                  │
 │             │              │                  │                  │
 │             │─HandleGameStatus()              │                  │
 │             │  (Paused)                        │                  │
 │             │──────────────────────────────────────────Pause()──→│
 │             │              │                  │                  │
```

---

## 5. 状態遷移図

### 5.1 モード状態遷移

```
┌─────────────┐
│             │
│  起動時      │
│             │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│           車両モード                      │
│                                         │
│  [ボタン押下]                            │
│    → メロディーループ再生                 │
│  [ボタンリリース]                         │
│    → メロディー停止 → アナウンス再生      │
└──┬──────────────────────────────────┬───┘
   │                                  ▲
   │ ボタン押下 + 駅在線                 │
   │                                  │
   ▼                                  │
┌─────────────────────────────────────┐  │
│           駅モード                   │  │
│                                     │  │
│  [ボタン押下 (初回)]                 │  │
│    → 駅メロディー再生                │  │
│    → ドア締まりますアナウンス         │  │
│  [ボタン押下 (2回目以降)]             │  │
│    → 車両モードの動作                 │  │
└──┬──────────────────────────────────┘  │
   │                                    │
   │ 駅発車 or ゲーム終了                 │
   └────────────────────────────────────┘
```

### 5.2 駅モード詳細状態遷移

```
      [OnEnter]
          │
          ▼
    ┌──────────┐
    │  待機     │
    └──┬───────┘
       │ ボタン押下 (初回)
       ▼
    ┌─────────────────┐
    │ メロディー再生中  │
    └──┬──────────────┘
       │ 再生完了
       ▼
    ┌─────────────────────┐
    │ アナウンス再生中      │
    └──┬──────────────────┘
       │ 再生完了
       ▼
    ┌──────────┐
    │  待機     │◄──────────┐
    └──┬───────┘            │
       │                    │
       │ ボタン押下 (2回目以降) │
       ▼                    │
    ┌─────────────────────┐ │
    │ メロディーループ再生  │ │
    └──┬──────────────────┘ │
       │ ボタンリリース        │
       ▼                    │
    ┌─────────────────────┐ │
    │ アナウンス再生中      │ │
    └──┬──────────────────┘ │
       │ 再生完了            │
       └────────────────────┘
```

---

## 6. エラーハンドリングフロー

### 6.1 音声ファイル読み込みエラー

```csharp
try
{
    audioPlayer.Play(filePath);
}
catch (FileNotFoundException ex)
{
    logger.Error($"Audio file not found: {filePath}", ex);
    // 無音で継続 (エラー通知のみ)
}
catch (Exception ex)
{
    logger.Error($"Failed to play audio: {filePath}", ex);
    // 無音で継続
}
```

### 6.2 プロファイル読み込みエラー

```csharp
try
{
    audioRepository.LoadProfile(profilePath);
}
catch (InvalidOperationException ex)
{
    // バリデーションエラー
    MessageBox.Show(ex.Message, "プロファイルエラー", MessageBoxButton.OK, MessageBoxImage.Error);

    // デフォルトプロファイル読み込み
    audioRepository.LoadProfile("profiles/profile_default.csv");
}
catch (Exception ex)
{
    logger.Error("Failed to load profile", ex);
    MessageBox.Show("プロファイルの読み込みに失敗しました。", "エラー", MessageBoxButton.OK, MessageBoxImage.Error);
}
```

### 6.3 API接続エラー

```csharp
private const int MaxRetryCount = 3;
private int _retryCount = 0;

public GameStatus GetGameStatus()
{
    try
    {
        var status = _api.GetGameStatus();
        _retryCount = 0; // 成功したらリセット
        return status;
    }
    catch (Exception ex)
    {
        _retryCount++;

        if (_retryCount >= MaxRetryCount)
        {
            logger.Error($"API connection failed after {MaxRetryCount} retries", ex);
            // デバッグパネルに警告表示
        }

        return GameStatus.Stopped;
    }
}
```

---

## 7. 設定ファイル仕様

### 7.1 appsettings.json

```json
{
  "ApiEndpoint": "http://localhost:8080",
  "CurrentProfile": "profiles/profile_default.csv",
  "StationDefinition": "stations/stations.csv",
  "TopmostMode": "PlayingOnly",
  "ShowOnPause": true,
  "Volume": 0.8,
  "WindowPosition": {
    "X": 100,
    "Y": 100
  },
  "WindowSize": {
    "Width": 300,
    "Height": 300
  },
  "InputKey": "Space",
  "LogLevel": "Info"
}
```

### 7.2 SettingsManager

```csharp
/// <summary>
/// 設定管理クラス
/// </summary>
public class SettingsManager
{
    private const string SettingsFileName = "appsettings.json";
    private AppSettings _settings;

    public AppSettings Settings => _settings;

    public void Load()
    {
        try
        {
            var json = File.ReadAllText(SettingsFileName);
            _settings = JsonConvert.DeserializeObject<AppSettings>(json);
        }
        catch (Exception ex)
        {
            // デフォルト設定使用
            _settings = new AppSettings();
        }
    }

    public void Save()
    {
        try
        {
            var json = JsonConvert.SerializeObject(_settings, Formatting.Indented);
            File.WriteAllText(SettingsFileName, json);
        }
        catch (Exception ex)
        {
            // エラーログ出力
        }
    }
}

public class AppSettings
{
    public string ApiEndpoint { get; set; } = "http://localhost:8080";
    public string CurrentProfile { get; set; } = "profiles/profile_default.csv";
    public string StationDefinition { get; set; } = "stations/stations.csv";
    public string TopmostMode { get; set; } = "PlayingOnly";
    public bool ShowOnPause { get; set; } = true;
    public double Volume { get; set; } = 0.8;
    public WindowPosition WindowPosition { get; set; } = new WindowPosition { X = 100, Y = 100 };
    public WindowSize WindowSize { get; set; } = new WindowSize { Width = 300, Height = 300 };
    public string InputKey { get; set; } = "Space";
    public string LogLevel { get; set; } = "Info";
}
```

---

**改訂履歴**

| バージョン | 日付 | 改訂者 | 改訂内容 |
|-----------|------|--------|----------|
| 1.0 | 2025-10-11 |  | 初版作成 |
