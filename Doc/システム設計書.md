# 乗降促進アプリ システム設計書

**バージョン**: 1.0
**作成日**: 2025年10月11日
**対象システム**: Traincrew 乗降促進アプリ

---

## 1. システム概要

### 1.1 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    乗降促進アプリ                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │            Presentation Layer (WPF)                │  │
│  │  ┌─────────────┐  ┌──────────────┐               │  │
│  │  │  MainWindow │  │SettingsWindow│               │  │
│  │  │  (UI)       │  │ (UI)         │               │  │
│  │  └──────┬──────┘  └───────┬──────┘               │  │
│  │         │                  │                       │  │
│  │         └──────────┬───────┘                       │  │
│  │                    │                               │  │
│  └────────────────────┼───────────────────────────────┘  │
│                       │                                  │
│  ┌────────────────────┼───────────────────────────────┐  │
│  │         Application Layer                          │  │
│  │         │                                           │  │
│  │  ┌──────▼──────────────────────────────┐           │  │
│  │  │    ModeManager                      │           │  │
│  │  │  ┌──────────┐    ┌──────────────┐  │           │  │
│  │  │  │StationMode│    │VehicleMode   │  │           │  │
│  │  │  └──────────┘    └──────────────┘  │           │  │
│  │  └─────┬────────────────┬──────────────┘           │  │
│  │        │                │                           │  │
│  │  ┌─────▼────┐    ┌──────▼──────┐                   │  │
│  │  │AudioPlayer│    │InputHandler │                   │  │
│  │  └─────┬────┘    └──────┬──────┘                   │  │
│  │        │                │                           │  │
│  └────────┼────────────────┼───────────────────────────┘  │
│           │                │                              │
│  ┌────────┼────────────────┼───────────────────────────┐  │
│  │  Infrastructure Layer   │                           │  │
│  │        │                │                           │  │
│  │  ┌─────▼────────┐  ┌───▼────────────┐              │  │
│  │  │AudioRepository│  │TraincrewApiClient│            │  │
│  │  └─────┬────────┘  └────────┬─────────┘             │  │
│  │        │                    │                       │  │
│  │  ┌─────▼────────┐  ┌────────▼─────────┐            │  │
│  │  │ProfileLoader │  │StationRepository │            │  │
│  │  └──────────────┘  └──────────────────┘            │  │
│  │                                                     │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
           │                        │
           │                        │
    ┌──────▼──────┐         ┌───────▼─────────┐
    │ CSV Files   │         │ Traincrew Game  │
    │ (Profile,   │         │ (API Provider)  │
    │  Station)   │         │                 │
    └─────────────┘         └─────────────────┘
```

### 1.2 アーキテクチャパターン

**採用パターン**: レイヤードアーキテクチャ + MVVM

- **Presentation Layer**: UI表示とユーザー操作
- **Application Layer**: ビジネスロジックとモード制御
- **Infrastructure Layer**: 外部I/O、データアクセス

---

## 2. コンポーネント設計

### 2.1 Presentation Layer

#### 2.1.1 MainWindow
**責務**:
- メイン画面の表示
- ボタン入力の受付
- 右クリックメニューの表示
- デバッグ画面の表示切替

**主要プロパティ**:
```csharp
public class MainWindow : Window
{
    private MainViewModel ViewModel { get; set; }
    private ContextMenu RightClickMenu { get; set; }
    private DebugPanel DebugPanel { get; set; }
}
```

#### 2.1.2 SettingsWindow
**責務**:
- 設定画面の表示
- プロファイル選択UI
- 駅定義CSV選択UI
- Topmost設定UI
- 音量調整UI

**主要プロパティ**:
```csharp
public class SettingsWindow : Window
{
    private SettingsViewModel ViewModel { get; set; }
    private ObservableCollection<string> ProfileList { get; set; }
}
```

#### 2.1.3 DebugPanel
**責務**:
- デバッグ情報のリアルタイム表示
- API接続状態の表示

**表示項目**:
- 現在のモード
- 在線駅名・番線
- 列番・上下線
- 在線軌道回路リスト
- 現在再生中の音声ファイル名
- API接続状態
- ゲーム状態

---

### 2.2 Application Layer

#### 2.2.1 ModeManager
**責務**:
- 駅モード/車両モードの切り替え制御
- モード判定ロジック
- 各モードへのイベント通知

**主要メソッド**:
```csharp
public class ModeManager
{
    public IMode CurrentMode { get; private set; }
    public StationMode StationMode { get; }
    public VehicleMode VehicleMode { get; }

    public void OnButtonPressed();
    public void OnButtonReleased();
    public void OnStationArrived(StationInfo station);
    public void OnStationDeparted();
    public void OnGameStatusChanged(GameStatus status);
    public void SwitchMode(IMode newMode);
}
```

**モード切替条件**:
| 現在のモード | イベント | 次のモード |
|------------|---------|-----------|
| 車両モード | ボタン押下 + 駅在線 | 駅モード |
| 駅モード | ボタン押下(初回) | 車両モード |
| 駅モード | 駅発車 | 車両モード |
| 駅モード | ゲーム終了 | 車両モード |

#### 2.2.2 StationMode
**責務**:
- 駅モードの動作制御
- 駅メロディー → ドア締まりますアナウンスの順次再生

**状態遷移**:
```
[待機] --ボタン押下--> [メロディー再生中] --再生完了--> [アナウンス再生中] --再生完了--> [完了]
   │                        │                        │
   └────────────────────────┴────────────────────────┴──> [車両モード移行]
           (発車 or ゲーム終了)
```

**主要メソッド**:
```csharp
public class StationMode : IMode
{
    private bool _isFirstPress = true;

    public void OnButtonPressed();
    public void OnButtonReleased(); // 無視
    public void PlayMelody();
    public void PlayDoorClosingAnnouncement();
    public void OnMelodyFinished();
}
```

#### 2.2.3 VehicleMode
**責務**:
- 車両モードの動作制御
- メロディーのループ再生制御
- アナウンスの停止・再生制御

**状態遷移**:
```
[待機] --ボタン押下--> [メロディーループ再生中] --ボタンリリース--> [アナウンス再生中] --再生完了--> [待機]
                           │                                        │
                           └────ボタン再押下────────────────────────┘
                                (アナウンス即停止)
```

**主要メソッド**:
```csharp
public class VehicleMode : IMode
{
    public void OnButtonPressed();
    public void OnButtonReleased();
    public void PlayMelodyLoop();
    public void StopMelody();
    public void PlayDoorClosingAnnouncement();
    public void StopAnnouncement();
}
```

#### 2.2.4 AudioPlayer
**責務**:
- WPF MediaPlayerを使用した音声再生
- ループ再生制御
- 音量制御
- ポーズ/再開制御

**主要メソッド**:
```csharp
public class AudioPlayer
{
    private MediaPlayer _player;

    public void Play(string filePath, bool loop = false);
    public void Stop();
    public void Pause();
    public void Resume();
    public void SetVolume(double volume); // 0.0 ~ 1.0
    public bool IsPlaying { get; }
    public string CurrentFile { get; }

    public event EventHandler PlaybackFinished;
}
```

#### 2.2.5 InputHandler
**責務**:
- 入力ソースの抽象化
- キーボード、GUIボタン、将来的なCOMポート入力の統一インターフェース

**主要メソッド**:
```csharp
public interface IInputSource
{
    event EventHandler ButtonPressed;
    event EventHandler ButtonReleased;
}

public class KeyboardInputSource : IInputSource { }
public class GuiButtonInputSource : IInputSource { }
public class ComPortInputSource : IInputSource { } // 将来実装

public class InputHandler
{
    private List<IInputSource> _inputSources;

    public void RegisterInputSource(IInputSource source);
    public void UnregisterInputSource(IInputSource source);
}
```

---

### 2.3 Infrastructure Layer

#### 2.3.1 TraincrewApiClient
**責務**:
- Traincrew APIとの通信
- ゲーム状態の取得
- 在線軌道回路リストの取得
- 列番の取得

**APIメソッドシグネチャ**:
```csharp
public class TraincrewApiClient
{
    // 実装は別途提供されるDLL/WebSocketを使用
    public GameStatus GetGameStatus();
    public List<string> GetTrackCircuits();
    public string GetTrainNumber();
    public bool IsConnected();
}

public enum GameStatus
{
    Running,
    Paused,
    Stopped
}
```

**ポーリング**:
- 更新間隔: 100ms (50Hz)
- 非同期処理で実装

#### 2.3.2 StationRepository
**責務**:
- 駅・番線定義CSVの読み込み
- 軌道回路セットと駅番線のマッピング
- 在線判定ロジック

**主要メソッド**:
```csharp
public class StationRepository
{
    private Dictionary<StationPlatform, HashSet<string>> _stationTracks;

    public void LoadFromCsv(string filePath);
    public StationInfo FindStation(List<string> occupiedTracks);
    public bool IsAtStation(List<string> occupiedTracks);
}

public class StationInfo
{
    public string StationName { get; set; }
    public int Platform { get; set; }
    public bool IsOddPlatform => Platform % 2 == 1;
}

public class StationPlatform
{
    public string StationName { get; set; }
    public int Platform { get; set; }
}
```

**在線判定アルゴリズム**:
```csharp
public StationInfo FindStation(List<string> occupiedTracks)
{
    var occupiedSet = new HashSet<string>(occupiedTracks);

    foreach (var (stationPlatform, trackSet) in _stationTracks)
    {
        if (occupiedSet.SetEquals(trackSet))
        {
            return new StationInfo
            {
                StationName = stationPlatform.StationName,
                Platform = stationPlatform.Platform
            };
        }
    }

    return null;
}
```

#### 2.3.3 AudioRepository
**責務**:
- 音声プロファイルCSVの読み込み
- 音声ファイルパスの管理
- 状況に応じた音声ファイルの選択

**主要メソッド**:
```csharp
public class AudioRepository
{
    private Dictionary<AudioKey, string> _audioFiles;

    public void LoadProfile(string profileCsvPath);
    public string GetStationMelody(string stationName, int platform);
    public string GetStationDoorClosing(bool isOddPlatform);
    public string GetVehicleMelody(Direction direction);
    public string GetVehicleDoorClosing();
    public ValidationResult ValidateProfile();
}

public enum AudioType
{
    StationMelody,
    StationDoorClosing,
    VehicleMelody,
    VehicleDoorClosing
}

public enum Direction
{
    Up,    // 上り (偶数列番)
    Down   // 下り (奇数列番)
}

public class AudioKey
{
    public AudioType Type { get; set; }
    public string StationName { get; set; }
    public int? Platform { get; set; }
    public bool? IsOdd { get; set; }
    public Direction? Direction { get; set; }
}

public class ValidationResult
{
    public bool IsValid { get; set; }
    public List<string> MissingEntries { get; set; }
    public List<string> MissingFiles { get; set; }
}
```

**フォールバック処理**:
```csharp
public string GetStationMelody(string stationName, int platform)
{
    var key = new AudioKey {
        Type = AudioType.StationMelody,
        StationName = stationName,
        Platform = platform
    };

    if (_audioFiles.TryGetValue(key, out var path))
    {
        return path;
    }

    // フォールバック: 車両メロディーを使用
    Logger.Warn($"駅メロディー未定義: {stationName} {platform}番線");
    var direction = DetermineDirection();
    return GetVehicleMelody(direction);
}
```

#### 2.3.4 ProfileLoader
**責務**:
- 音声プロファイルCSVの解析
- CSVバリデーション
- エラーメッセージの生成

**主要メソッド**:
```csharp
public class ProfileLoader
{
    public Dictionary<AudioKey, string> LoadFromCsv(string csvPath);
    public ValidationResult Validate(Dictionary<AudioKey, string> audioFiles);
    private bool CheckFileExists(string filePath);
    private List<string> GetRequiredEntries();
}
```

---

## 3. データフロー

### 3.1 ボタン押下時の処理フロー (駅モード)

```
[ユーザー]
   │ ボタン押下
   ▼
[MainWindow]
   │ OnButtonPressed
   ▼
[InputHandler]
   │ ButtonPressed event
   ▼
[ModeManager]
   │ 駅在線判定
   ├─ [TraincrewApiClient] GetTrackCircuits()
   ├─ [StationRepository] FindStation()
   │
   │ 駅モードに切替
   ▼
[StationMode]
   │ OnButtonPressed (初回のみ)
   ├─ [AudioRepository] GetStationMelody()
   ├─ [AudioPlayer] Play(melody)
   │
   │ メロディー再生完了
   ├─ [AudioRepository] GetStationDoorClosing()
   ├─ [AudioPlayer] Play(doorClosing)
   │
   │ アナウンス再生完了
   ▼
[ModeManager]
   │ 車両モードに切替
   ▼
[VehicleMode]
```

### 3.2 ゲーム状態監視フロー

```
[Timer (100ms間隔)]
   │
   ▼
[TraincrewApiClient]
   │ GetGameStatus()
   │ GetTrackCircuits()
   │ GetTrainNumber()
   ▼
[ModeManager]
   │ 状態変化検知
   │
   ├─ ゲームポーズ → [AudioPlayer] Pause()
   ├─ ゲーム再開 → [AudioPlayer] Resume()
   ├─ ゲーム終了 → [AudioPlayer] Stop()
   │
   ├─ 駅到着検知 → OnStationArrived()
   └─ 駅発車検知 → OnStationDeparted()
```

### 3.3 設定読み込みフロー

```
[アプリ起動]
   │
   ▼
[SettingsManager]
   │ appsettings.json 読み込み
   ├─ CurrentProfile
   ├─ StationDefinition
   ├─ TopmostMode
   └─ Volume
   │
   ├─ [ProfileLoader] LoadFromCsv(CurrentProfile)
   │   │
   │   ├─ CSV解析
   │   ├─ バリデーション
   │   │   ├─ 必須エントリーチェック
   │   │   └─ ファイル存在チェック
   │   │
   │   └─ [AudioRepository] に登録
   │
   └─ [StationRepository] LoadFromCsv(StationDefinition)
       │
       ├─ CSV解析
       └─ 軌道回路セット構築
```

---

## 4. 状態管理

### 4.1 アプリケーション状態

```csharp
public class ApplicationState
{
    // モード状態
    public ModeType CurrentMode { get; set; }

    // ゲーム状態
    public GameStatus GameStatus { get; set; }
    public List<string> OccupiedTracks { get; set; }
    public string TrainNumber { get; set; }
    public Direction Direction { get; set; }

    // 在線情報
    public StationInfo CurrentStation { get; set; }
    public bool IsAtStation { get; set; }

    // 再生状態
    public string CurrentAudioFile { get; set; }
    public bool IsAudioPlaying { get; set; }

    // 設定
    public string CurrentProfile { get; set; }
    public double Volume { get; set; }
    public TopmostMode TopmostMode { get; set; }
}

public enum ModeType
{
    Station,
    Vehicle
}

public enum TopmostMode
{
    Always,
    PlayingOnly,
    AtStationOnly,
    None
}
```

### 4.2 Topmost制御

```csharp
public class TopmostController
{
    private MainWindow _window;
    private TopmostMode _mode;
    private bool _showOnPause;

    public void Update(ApplicationState state)
    {
        bool shouldBeTopmost = _mode switch
        {
            TopmostMode.Always => true,
            TopmostMode.PlayingOnly => state.GameStatus == GameStatus.Running || (_showOnPause && state.GameStatus == GameStatus.Paused),
            TopmostMode.AtStationOnly => state.IsAtStation && (state.GameStatus == GameStatus.Running || (_showOnPause && state.GameStatus == GameStatus.Paused)),
            TopmostMode.None => false,
            _ => false
        };

        _window.Topmost = shouldBeTopmost;
    }
}
```

---

## 5. エラーハンドリング

### 5.1 例外処理方針

| エラー種別 | 処理方針 |
|-----------|---------|
| CSV読み込みエラー | エラーメッセージ表示、デフォルト値使用 |
| 音声ファイル読み込みエラー | ログ出力、無音で継続 |
| API接続エラー | リトライ(最大3回)、デバッグパネルに警告表示 |
| プロファイル検証エラー | エラーダイアログ表示、読み込み中止 |

### 5.2 ログ出力

```csharp
public interface ILogger
{
    void Info(string message);
    void Warn(string message);
    void Error(string message, Exception ex = null);
}

public class FileLogger : ILogger
{
    private string _logDirectory = "log";
    private string _logFileName; // YYYYMMDDhhmmss.txt

    public FileLogger()
    {
        _logFileName = DateTime.Now.ToString("yyyyMMddHHmmss") + ".txt";
    }

    public void Info(string message) => WriteLog("INFO", message);
    public void Warn(string message) => WriteLog("WARN", message);
    public void Error(string message, Exception ex = null) => WriteLog("ERROR", message, ex);

    private void WriteLog(string level, string message, Exception ex = null)
    {
        var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss.fff");
        var logMessage = $"[{timestamp}] [{level}] {message}";

        if (ex != null)
        {
            logMessage += $"\n{ex}";
        }

        File.AppendAllText(Path.Combine(_logDirectory, _logFileName), logMessage + "\n");
    }
}
```

### 5.3 プロファイル検証エラーメッセージ

```csharp
public string GenerateValidationErrorMessage(ValidationResult result)
{
    var sb = new StringBuilder();
    sb.AppendLine("エラー: プロファイルの読み込みに失敗しました");
    sb.AppendLine();

    if (result.MissingEntries.Any())
    {
        sb.AppendLine("必須エントリー不足:");
        foreach (var entry in result.MissingEntries)
        {
            sb.AppendLine($"- {entry}");
        }
        sb.AppendLine();
    }

    if (result.MissingFiles.Any())
    {
        sb.AppendLine("ファイルが見つかりません:");
        foreach (var file in result.MissingFiles)
        {
            sb.AppendLine($"- {file}");
        }
        sb.AppendLine();
    }

    sb.AppendLine("プロファイルを修正してから再度読み込んでください。");

    return sb.ToString();
}
```

---

## 6. パフォーマンス要件

### 6.1 応答性能

| 項目 | 目標値 |
|-----|-------|
| ボタン押下からメロディー再生開始まで | < 100ms |
| API状態取得間隔 | 100ms |
| 駅判定処理時間 | < 50ms |
| UI更新レート | 60 FPS |

### 6.2 メモリ使用量

- 通常動作時: < 100 MB
- 音声ファイル読み込み: ストリーミング再生でメモリ節約

---

## 7. セキュリティ

### 7.1 ファイルアクセス制限

- CSVファイル読み込み時のパストラバーサル対策
- 音声ファイル読み込み時の拡張子チェック

### 7.2 API通信

- ローカルホスト限定(外部への通信は行わない)
- タイムアウト設定(5秒)

---

## 8. デプロイメント

### 8.1 ディレクトリ構成

```
TraincrewDepMelody/
├── TraincrewDepMelody.exe
├── appsettings.json
├── profiles/
│   ├── profile_default.csv
│   └── profile_custom1.csv
├── stations/
│   └── stations.csv
├── sounds/
│   ├── station/
│   │   ├── 渋谷_1.mp3
│   │   └── ...
│   ├── door/
│   │   ├── door_odd.mp3
│   │   ├── door_even.mp3
│   │   └── door_train.mp3
│   └── vehicle/
│       ├── melody_up.mp3
│       └── melody_down.mp3
└── log/
    └── (自動生成)
```

### 8.2 初期設定ファイル

**appsettings.json**:
```json
{
  "ApiEndpoint": "http://localhost:8080",
  "CurrentProfile": "profiles/profile_default.csv",
  "StationDefinition": "stations/stations.csv",
  "TopmostMode": "PlayingOnly",
  "ShowOnPause": true,
  "Volume": 0.8,
  "WindowPosition": { "X": 100, "Y": 100 },
  "InputKey": "Space"
}
```

---

## 9. 依存関係

### 9.1 外部ライブラリ

| ライブラリ | 用途 | バージョン |
|-----------|-----|----------|
| .NET | ランタイム | 8.0 |
| WPF | UIフレームワーク | 標準 |
| CsvHelper | CSV読み込み | 33.1.0 |
| Newtonsoft.Json | JSON設定読み込み | 13.0.4 |
| Microsoft.Extensions.Logging | ログ機能 | 9.0.9 |
| Microsoft.Extensions.Logging.Console | コンソールログ | 9.0.9 |

### 9.2 Traincrew API DLL

- DLL名: TrainCrewInput.dll
- 配置場所: TraincrewDepMelody/DLL/
- インターフェース: `ITraincrewApi`
- 現在の実装: `MockTraincrewApi` (モック実装)

---

## 10. 今後の拡張計画

### 10.1 Phase 2 対応項目

- COMポート入力対応
  - `ComPortInputSource` クラスの実装
  - 設定画面にCOMポート選択UI追加

### 10.2 Phase 3 対応項目

- 音声ファイルのホットリロード
- プロファイルGUIエディタ
- 音声プレビュー機能

---

**改訂履歴**

| バージョン | 日付 | 改訂者 | 改訂内容 |
|-----------|------|--------|----------|
| 1.0 | 2025-10-11 |  | 初版作成 |
