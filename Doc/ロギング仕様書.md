# 乗降促進アプリ ロギング仕様書

**バージョン**: 1.0
**作成日**: 2025年10月11日
**対象システム**: Traincrew 乗降促進アプリ

---

## 1. 概要

本アプリケーションでは、C#標準の`Microsoft.Extensions.Logging`を使用してロギングを実装します。

---

## 2. ロギングライブラリ

### 2.1 使用ライブラリ

| ライブラリ | 用途 | 備考 |
|-----------|-----|------|
| Microsoft.Extensions.Logging | ロギング基盤 | C#標準 |
| Microsoft.Extensions.Logging.Console | コンソール出力 | デバッグ用 |
| Serilog.Extensions.Logging.File | ファイル出力 | 推奨 |

### 2.2 ILogger<T>の使用

各クラスでジェネリック型の`ILogger<T>`を使用します。

```csharp
using Microsoft.Extensions.Logging;

public class SomeClass
{
    private readonly ILogger<SomeClass> _logger;

    public SomeClass(ILogger<SomeClass> logger)
    {
        _logger = logger;
    }

    public void DoSomething()
    {
        _logger.LogInformation("処理を開始しました");
        _logger.LogWarning("警告メッセージ");
        _logger.LogError(exception, "エラーが発生しました");
    }
}
```

---

## 3. ログレベル

### 3.1 レベル定義

| レベル | 用途 | 例 |
|-------|-----|---|
| LogTrace | 詳細なトレース情報 | メソッド呼び出しの開始/終了 |
| LogDebug | デバッグ情報 | 変数の値、内部状態 |
| LogInformation | 通常の動作情報 | アプリ起動、設定読み込み、モード切替 |
| LogWarning | 警告（動作は継続） | フォールバック動作、軽微なエラー |
| LogError | エラー（動作に影響） | ファイル読み込み失敗、API接続失敗 |
| LogCritical | 重大なエラー | アプリがクラッシュする可能性のあるエラー |

### 3.2 デフォルトログレベル

- **開発環境**: `LogDebug`
- **本番環境**: `LogInformation`

---

## 4. ログ出力先

### 4.1 ファイル出力

**出力先**: `log/` ディレクトリ
**ファイル名形式**: `YYYYMMDDhhmmss.txt`

例: `20251011120000.txt`

### 4.2 コンソール出力

デバッグ時のみ有効化（`DEBUG`ビルド時）

---

## 5. ログフォーマット

### 5.1 基本フォーマット

```
[YYYY-MM-DD HH:mm:ss.fff] [LEVEL] [ClassName] メッセージ
```

**例**:
```
[2025-10-11 12:00:00.123] [Information] [MainViewModel] Button pressed
[2025-10-11 12:00:05.456] [Warning] [AudioRepository] Station melody not found: 原宿 1番線 (using vehicle melody as fallback)
[2025-10-11 12:00:10.789] [Error] [AudioPlayer] Failed to play audio: sounds/missing.mp3
System.IO.FileNotFoundException: Could not find file 'C:\...\sounds\missing.mp3'.
   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)
   ...
```

### 5.2 構造化ロギング

`Microsoft.Extensions.Logging`の構造化ロギング機能を使用します。

```csharp
// 良い例
_logger.LogInformation("Playing on channel '{ChannelId}': {FileName} (Loop: {Loop})",
    channelId, Path.GetFileName(filePath), loop);

// 悪い例（文字列補間は使わない）
_logger.LogInformation($"Playing on channel '{channelId}': {Path.GetFileName(filePath)} (Loop: {loop})");
```

---

## 6. ロガー設定

### 6.1 Program.cs での設定

```csharp
using Microsoft.Extensions.Logging;
using Serilog;

public class Program
{
    public static void Main(string[] args)
    {
        // Serilog 設定
        Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Information()
            .WriteTo.Console()
            .WriteTo.File(
                path: $"log/{DateTime.Now:yyyyMMddHHmmss}.txt",
                outputTemplate: "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff}] [{Level}] [{SourceContext}] {Message}{NewLine}{Exception}"
            )
            .CreateLogger();

        try
        {
            var app = new App();
            app.InitializeComponent();
            app.Run();
        }
        catch (Exception ex)
        {
            Log.Fatal(ex, "Application terminated unexpectedly");
        }
        finally
        {
            Log.CloseAndFlush();
        }
    }
}
```

### 6.2 Dependency Injection での設定

```csharp
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // ロギング設定
        services.AddLogging(builder =>
        {
            builder
                .AddConsole()
                .AddSerilog()
                .SetMinimumLevel(LogLevel.Information);
        });

        // サービス登録
        services.AddSingleton<AudioPlayer>();
        services.AddSingleton<AudioRepository>();
        services.AddSingleton<StationRepository>();
        services.AddSingleton<TraincrewApiClient>();
        services.AddSingleton<ModeManager>();
    }
}
```

---

## 7. ログ出力例

### 7.1 アプリケーション起動時

```
[2025-10-11 12:00:00.000] [Information] [Program] Application starting
[2025-10-11 12:00:00.100] [Information] [SettingsManager] Loading application settings
[2025-10-11 12:00:00.200] [Information] [AudioRepository] Loading audio profile: profiles/profile_default.csv
[2025-10-11 12:00:00.300] [Information] [AudioRepository] Loaded 55 audio entries
[2025-10-11 12:00:00.400] [Information] [StationRepository] Loading station definition: stations/stations.csv
[2025-10-11 12:00:00.500] [Information] [StationRepository] Loaded 24 station platforms
[2025-10-11 12:00:00.600] [Information] [TraincrewApiClient] Connecting to Traincrew API: http://localhost:8080
[2025-10-11 12:00:00.700] [Information] [TraincrewApiClient] Connected to Traincrew API
[2025-10-11 12:00:00.800] [Information] [Program] Application started successfully
```

### 7.2 駅モード動作時

```
[2025-10-11 12:05:00.000] [Information] [MainViewModel] Button pressed
[2025-10-11 12:05:00.010] [Information] [ModeManager] Mode switch: VehicleMode -> StationMode
[2025-10-11 12:05:00.020] [Information] [StationMode] Enter StationMode
[2025-10-11 12:05:00.030] [Information] [StationMode] StationMode: First button press
[2025-10-11 12:05:00.040] [Information] [StationMode] Playing station melody: sounds/station/shibuya_1.mp3
[2025-10-11 12:05:00.050] [Information] [AudioPlayer] Playing on channel 'station': shibuya_1.mp3 (Loop: False)
[2025-10-11 12:05:15.000] [Information] [AudioPlayer] Playback finished on channel 'station'
[2025-10-11 12:05:15.010] [Information] [StationMode] Playing station door closing: sounds/door/door_odd.mp3
[2025-10-11 12:05:15.020] [Information] [AudioPlayer] Playing on channel 'station': door_odd.mp3 (Loop: False)
```

### 7.3 エラー発生時

```
[2025-10-11 12:10:00.000] [Warning] [AudioRepository] Station melody not found: 原宿 1番線 (using vehicle melody as fallback)
[2025-10-11 12:10:05.000] [Error] [AudioPlayer] Audio file not found: sounds/missing.mp3
[2025-10-11 12:10:10.000] [Error] [TraincrewApiClient] API call failed (attempt 1/3): Connection refused
[2025-10-11 12:10:11.000] [Error] [TraincrewApiClient] API call failed (attempt 2/3): Connection refused
[2025-10-11 12:10:12.000] [Error] [TraincrewApiClient] API call failed (attempt 3/3): Connection refused
[2025-10-11 12:10:12.100] [Error] [TraincrewApiClient] API call failed after 3 attempts. Returning default value.
[2025-10-11 12:10:12.200] [Error] [TraincrewApiClient] API connection unstable: 5 consecutive failures
```

---

## 8. ログローテーション

### 8.1 方式

- **起動時**: 新規ログファイル作成
- **実行中**: 同一ファイルに追記

### 8.2 古いログの削除

手動削除（将来拡張で自動削除機能を実装予定）

**将来実装案**:
- 30日以上前のログファイルを自動削除
- ログファイルサイズが一定値（例: 100MB）を超えたら分割

---

## 9. パフォーマンス考慮事項

### 9.1 非同期ロギング

Serilogの非同期書き込み機能を使用して、ログ出力がアプリのパフォーマンスに影響しないようにします。

```csharp
Log.Logger = new LoggerConfiguration()
    .WriteTo.Async(a => a.File($"log/{DateTime.Now:yyyyMMddHHmmss}.txt"))
    .CreateLogger();
```

### 9.2 ログレベルフィルタリング

本番環境では`LogDebug`や`LogTrace`を無効化してパフォーマンスを向上させます。

---

## 10. セキュリティ

### 10.1 機密情報のマスキング

ログに機密情報（パスワード、トークンなど）を出力しないようにします。

```csharp
// 良い例
_logger.LogInformation("User logged in: {UserId}", userId);

// 悪い例
_logger.LogInformation("User logged in: {UserId}, Password: {Password}", userId, password);
```

本アプリケーションでは、APIエンドポイント、ファイルパスなどは出力しますが、個人情報は扱わないため、特別な対策は不要です。

---

**改訂履歴**

| バージョン | 日付 | 改訂者 | 改訂内容 |
|-----------|------|--------|----------|
| 1.0 | 2025-10-11 |  | 初版作成 |
