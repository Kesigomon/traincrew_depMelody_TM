# 乗降促進アプリ 要件定義書

**バージョン**: 1.0  
**作成日**: 2025年10月10日  
**対象ゲーム**: Traincrew

---

## 1. プロジェクト概要

### 1.1 目的
Traincrewのプレイ体験を向上させるため、駅および車両での乗降促進メロディーとアナウンスを状況に応じて再生するデスクトップアプリケーションを開発する。

### 1.2 開発環境
- **プラットフォーム**: Windows専用
- **開発言語**: C# (.NET)
- **UIフレームワーク**: WPF (Windows Presentation Foundation)
- **音声再生**: WPF MediaPlayer

---

## 2. 機能要件

### 2.1 モード管理

アプリケーションは以下2つのモードを持つ。

#### 2.1.1 駅モード
**発動条件**:
- 列車が駅に停車している状態で、最初の1回のボタン押下時

**動作**:
- ボタンを押した時点で以下を順次再生:
  1. 乗降促進メロディー(駅)
  2. ドアが締まりますアナウンス(駅・奇数番/偶数番)
- ボタンの離す操作は無視
- メロディー・アナウンス再生中の再押下は車両モードの挙動に従う

**モード解除条件**:
- ボタンを1回押した時点
- 駅を発車した時点
- ゲームが終了した時点

#### 2.1.2 車両モード
**発動条件**:
- 駅モード以外の全ての状態

**動作**:
- ボタン押下中: 乗降促進メロディー(車両)をループ再生
- ボタンリリース時: メロディー停止 → ドアが締まりますアナウンス(車両)を再生
- 再押下時: アナウンス即停止 → メロディーを再度ループ再生

### 2.2 音声再生機能

#### 2.2.1 音声ファイル種別

| 種別 | 数量 | 選択基準 |
|------|------|----------|
| 乗降促進メロディー(駅) | 49種類(駅数×番線数) | 駅名・番線番号 |
| ドアが締まります(駅) | 2種類 | 奇数番線/偶数番線 |
| 乗降促進メロディー(車両) | 2種類 | 上り/下り |
| ドアが締まります(車両) | 1種類 | 共通 |

#### 2.2.2 対応ファイル形式
- WPF MediaPlayerで再生可能な全ての形式(MP3, WAV, WMA等)

#### 2.2.3 再生制御
- **ポーズ時**: Traincrewがポーズ中の場合、音声を一時停止
- **終了時**: Traincrewが運転終了状態の場合、音声を停止

### 2.3 Traincrew連携機能

#### 2.3.1 API連携
- **取得情報**:
  - ゲーム状態(実行中/ポーズ中/終了)
  - 列車が在線している軌道回路リスト
  - 列番

#### 2.3.2 駅判定ロジック
**方式**: 軌道回路の集合完全一致

**手順**:
1. APIから現在在線中の軌道回路リストを取得
2. 駅・番線定義CSVから各駅番線の軌道回路セットを読み込み
3. 在線軌道回路セットと駅番線軌道回路セットを比較(順不同)
4. 完全一致した場合、その駅番線に在線していると判定

**例**:
```
在線軌道回路: [SB-01, SB-02, SB-03]
CSV定義:
  渋谷1番線: [SB-01, SB-02, SB-03] → 一致(在線)
  渋谷2番線: [SB-04, SB-05] → 不一致
  
在線軌道回路: [SB-04, SB-05, SB-06]
  どの駅番線とも一致しない → 在線なし
```

#### 2.3.3 上下線判定
**方式**: 列番の偶奇判定
- 偶数列番(例: 1262, 回1302A) → 上り
- 奇数列番(例: 1261, 回1301A) → 下り
- 判定は数字部分の最後の桁で行う

### 2.4 入力機能

#### 2.4.1 入力方式(拡張性を考慮した設計)

**初期実装**:
- キーボード入力
- GUIボタンクリック

**将来的な拡張**:
- COMポート経由のリアルボタン入力

**設計方針**: 入力ソースを抽象化し、プラグイン的に追加可能な構造とする

### 2.5 設定管理機能

#### 2.5.1 音声プロファイル
**形式**: CSV
**管理方法**: 複数のプロファイルCSVを用意し、設定画面で切り替え可能

**CSVフォーマット例**:
```csv
種別,駅名,番線,上下,ファイルパス
駅メロディー,渋谷,1,,sounds/shibuya_1.mp3
駅メロディー,渋谷,2,,sounds/shibuya_2.mp3
駅ドア締まります,,,奇数,sounds/door_odd.mp3
駅ドア締まります,,,偶数,sounds/door_even.mp3
車両メロディー,,,上り,sounds/train_up.mp3
車両メロディー,,,下り,sounds/train_down.mp3
車両ドア締まります,,,,sounds/door_train.mp3
```

**プロファイル読み込み時の検証**:

1. **必須エントリーの確認**
   - 以下のエントリーが必ず存在することを確認する
   - 不足している場合はエラーを表示し、プロファイル読み込みを中止する
   
   必須エントリー:
   - 車両メロディー(上り)
   - 車両メロディー(下り)
   - 車両ドア締まります

2. **ファイル存在チェック**
   - 各エントリーのファイルパスに指定されたファイルが実際に存在するか確認
   - 存在しないファイルがある場合、エラーメッセージに該当ファイルパスを表示
   - 1つでもファイルが見つからない場合、プロファイル読み込みを中止する

3. **フォールバック動作**
   - 駅モードで該当する「駅メロディー」が設定されていない場合:
     - 上下線に応じた「車両メロディー」を代わりに再生する
     - ログに警告メッセージを出力する
   - 「駅ドア締まります」(奇数/偶数)が設定されていない場合:
     - 「車両ドア締まります」を代わりに再生する
     - ログに警告メッセージを出力する

**検証エラーメッセージ例**:
```
エラー: プロファイルの読み込みに失敗しました

必須エントリー不足:
- 車両メロディー(下り)が定義されていません

ファイルが見つかりません:
- sounds/train_up.mp3
- sounds/door_train.mp3

プロファイルを修正してから再度読み込んでください。
```

#### 2.5.2 駅・番線定義
**形式**: CSV
**管理方法**: 単一のCSVファイルで管理

**CSVフォーマット例**:
```csv
駅名,番線,軌道回路1,軌道回路2,軌道回路3,軌道回路4
渋谷,1,SB-01,SB-02,SB-03,
渋谷,2,SB-04,SB-05,,
新宿,1,SJ-01,SJ-02,SJ-03,SJ-04
```
※軌道回路列は可変長に対応

#### 2.5.3 Topmost設定
**表示レベルモード**:
- 常に最前面
- プレイ中のみ最前面
- 駅在線時のみ最前面
- なし(最前面表示しない)

**追加オプション**:
- 「ポーズ時も前面に出す」チェックボックス
  - 「なし」モード選択時は無効化(グレーアウト)

---

## 3. UI要件

### 3.1 メイン画面
**構成**:
- 丸い大きなボタン1個のみのシンプルなウィンドウ
- ウィンドウサイズ: コンパクト(推奨300x300px程度)
- ウィンドウ位置: 自由に移動可能

**操作**:
- 左クリック: ボタン押下/リリース
- 右クリック: 設定メニュー表示

### 3.2 設定画面
**表示方法**: メイン画面の右クリックメニューから起動

**設定項目**:
- 音声プロファイル選択(ドロップダウン)
- 駅・番線定義CSV選択(ファイルパス指定)
- Topmost設定
  - モード選択(ラジオボタン)
  - ポーズ時も前面に出すチェックボックス
- 入力設定(将来拡張用の枠を確保)
- 音量調整(スライダー)

### 3.3 デバッグ画面
**表示方法**: 特殊キー操作(例: Ctrl+Shift+D)

**表示内容**:
- 現在のモード(駅モード/車両モード)
- 在線駅名・番線
- 列番・上下線
- 在線軌道回路リスト
- 現在再生中の音声ファイル名
- API接続状態
- ゲーム状態(実行中/ポーズ中/終了)

---

## 4. 非機能要件

### 4.1 信頼性
- 音声ファイル読み込みエラー時のフォールバック(無音で動作継続)
- CSV読み込みエラー時のエラーメッセージ表示

### 4.2 保守性
- ログ出力機能(デバッグ用)
- 設定ファイルの外部化(XMLまたはJSON)
- コードの拡張性を考慮した設計(入力ソースの追加が容易)

### 4.3 ユーザビリティ
- 初回起動時のセットアップウィザード
- わかりやすいエラーメッセージ
- 設定変更の即時反映

---

## 5. データ仕様

### 5.1 駅・番線定義CSV
**ファイル名**: `stations.csv`  
**エンコーディング**: UTF-8  
**フォーマット**: 
- 1行目: ヘッダー行
- 2行目以降: データ行
- 軌道回路列は可変長(空白セルはスキップ)

### 5.2 音声プロファイルCSV
**ファイル名**: `profile_*.csv` (例: `profile_default.csv`, `profile_custom1.csv`)  
**エンコーディング**: UTF-8  
**フォーマット**:
- 1行目: ヘッダー行
- 2行目以降: データ行
- ファイルパスは相対パスまたは絶対パス

### 5.3 アプリケーション設定ファイル
**ファイル名**: `appsettings.json`  
**形式**: JSON
**エンコーディング**: UTF-8  
**内容**:
```json
{
  "ApiEndpoint": "http://localhost:8080",
  "CurrentProfile": "profile_default.csv",
  "StationDefinition": "stations.csv",
  "TopmostMode": "PlayingOnly",
  "ShowOnPause": true,
  "Volume": 0.8,
  "WindowPosition": { "X": 100, "Y": 100 }
}
```

---

## 6. 制約事項

### 6.1 技術的制約
- Windows 10以降でのみ動作保証
- .NET 8.0以降のランタイムが必要
- Traincrew APIが起動していることが前提

### 6.2 運用上の制約
- 音声ファイルはユーザーが自身で用意する必要がある
- 駅・番線定義CSVはマップ追加時に手動で更新が必要
- 同時に1つのプロファイルのみ使用可能

---

## 7. 将来的な拡張要件

### 7.1 優先度: 高
- COMポート経由のリアルボタン入力対応
- 複数駅での連続乗降促進対応
- 音声ファイルのホットリロード

### 7.2 優先度: 中
- プロファイルのGUIエディタ
- 駅・番線定義の自動インポート機能
- 音声プレビュー機能

### 7.3 優先度: 低
- 音声エフェクト(フェードイン/アウト等)
- 多言語対応
- テーマ・スキン機能

---

## 8. テスト要件

### 8.1 単体テスト
- 軌道回路集合比較ロジック
- 列番の上下線判定ロジック
- CSV読み込み処理
- モード切り替えロジック

### 8.2 結合テスト
- Traincrew API連携
- 音声再生制御
- 各種設定の保存・読み込み

### 8.3 シナリオテスト
- 駅到着から発車までの一連の操作
- ポーズ・再開・終了時の動作
- プロファイル切り替え時の動作

---

## 9. リリース計画

### Phase 1 (MVP)
- 基本的な駅モード・車両モードの実装
- キーボード・GUI入力対応
- 設定画面の実装

### Phase 2
- デバッグ画面の実装
- エラーハンドリングの強化
- パフォーマンスチューニング

### Phase 3
- COMポート対応の実装
- ユーザーフィードバック反映
- ドキュメント整備

---

## 10. 付録

### 10.1 用語集
| 用語 | 説明 |
|------|------|
| 乗降促進 | 乗客のスムーズな乗降を促すためのメロディーやアナウンス |
| 軌道回路 | 列車の位置を検知するための電気回路の区間 |
| 列番 | 列車に割り当てられた番号(運行番号) |
| Topmost | ウィンドウを常に最前面に表示する属性 |


---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| 要件定義者 |  |  |  |
| 開発責任者 |  |  |  |
| レビュー担当 |  |  |  |

---

**改訂履歴**

| バージョン | 日付 | 改訂者 | 改訂内容 |
|-----------|------|--------|----------|
| 1.0 | 2025-10-10 |  | 初版作成 |