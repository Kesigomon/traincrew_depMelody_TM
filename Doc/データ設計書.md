# 乗降促進アプリ データ設計書

**バージョン**: 1.0
**作成日**: 2025年10月11日
**対象システム**: Traincrew 乗降促進アプリ

---

## 1. データ構造概要

本アプリケーションでは、以下のデータソースを使用します。

| データソース | 形式 | 用途 |
|------------|------|------|
| 音声プロファイルCSV | CSV | 音声ファイルとシチュエーションのマッピング |
| 駅・番線定義CSV | CSV | 駅・番線と軌道回路セットのマッピング |
| アプリケーション設定ファイル | JSON | アプリケーション動作設定 |
| ログファイル | テキスト | 動作ログ、エラーログ |

---

## 2. CSV仕様

### 2.1 音声プロファイルCSV

#### 2.1.1 ファイル仕様

| 項目 | 値 |
|-----|---|
| ファイル名 | `profile_*.csv` (例: `profile_default.csv`, `profile_custom1.csv`) |
| エンコーディング | UTF-8 (BOM付き推奨) |
| 改行コード | CRLF (Windows標準) |
| 区切り文字 | カンマ (`,`) |
| クォート | ダブルクォート (`"`) (フィールドにカンマが含まれる場合) |

#### 2.1.2 カラム定義

| カラム名 | データ型 | 必須 | 説明 | 例 |
|---------|---------|------|-----|---|
| 種別 | 文字列 | ○ | 音声種別 | `駅メロディー`, `駅ドア締まります`, `車両メロディー`, `車両ドア締まります` |
| 駅名 | 文字列 | △ | 駅名 (駅メロディーの場合のみ必須) | `渋谷`, `新宿` |
| 番線 | 整数 | △ | 番線番号 (駅メロディーの場合のみ必須) | `1`, `2` |
| 上下 | 文字列 | △ | 上下線または奇数偶数 | `上り`, `下り`, `奇数`, `偶数` |
| ファイルパス | 文字列 | ○ | 音声ファイルの相対パスまたは絶対パス | `sounds/shibuya_1.mp3` |

#### 2.1.3 データ例

```csv
種別,駅名,番線,上下,ファイルパス
駅メロディー,渋谷,1,,sounds/station/shibuya_1.mp3
駅メロディー,渋谷,2,,sounds/station/shibuya_2.mp3
駅メロディー,新宿,1,,sounds/station/shinjuku_1.mp3
駅メロディー,新宿,2,,sounds/station/shinjuku_2.mp3
駅ドア締まります,,,奇数,sounds/door/door_odd.mp3
駅ドア締まります,,,偶数,sounds/door/door_even.mp3
車両メロディー,,,上り,sounds/vehicle/melody_up.mp3
車両メロディー,,,下り,sounds/vehicle/melody_down.mp3
車両ドア締まります,,,,sounds/door/door_train.mp3
```

#### 2.1.4 種別ごとの記入規則

| 種別 | 駅名 | 番線 | 上下 | ファイルパス |
|-----|------|------|------|------------|
| 駅メロディー | 必須 | 必須 | 空欄 | 必須 |
| 駅ドア締まります | 空欄 | 空欄 | `奇数` or `偶数` | 必須 |
| 車両メロディー | 空欄 | 空欄 | `上り` or `下り` | 必須 |
| 車両ドア締まります | 空欄 | 空欄 | 空欄 | 必須 |

#### 2.1.5 必須エントリー

以下のエントリーは必ず定義する必要があります。不足している場合、プロファイル読み込みが失敗します。

- 車両メロディー (上り)
- 車両メロディー (下り)
- 車両ドア締まります

#### 2.1.6 バリデーションルール

| ルール | エラー処理 |
|--------|-----------|
| 必須エントリーが不足 | エラーメッセージ表示、プロファイル読み込み中止 |
| ファイルパスが存在しない | エラーメッセージ表示、プロファイル読み込み中止 |
| CSV形式が不正 | エラーメッセージ表示、プロファイル読み込み中止 |

#### 2.1.7 フォールバック動作

| 状況 | フォールバック動作 |
|-----|-----------------|
| 駅メロディーが未定義 | 車両メロディー (上下線に応じる) を再生 |
| 駅ドア締まりますが未定義 | 車両ドア締まります を再生 |

---

### 2.2 駅・番線定義CSV

#### 2.2.1 ファイル仕様

| 項目 | 値 |
|-----|---|
| ファイル名 | `stations.csv` (固定) |
| エンコーディング | UTF-8 (BOM付き推奨) |
| 改行コード | CRLF (Windows標準) |
| 区切り文字 | カンマ (`,`) |
| クォート | ダブルクォート (`"`) (フィールドにカンマが含まれる場合) |

#### 2.2.2 カラム定義

| カラム名 | データ型 | 必須 | 説明 | 例 |
|---------|---------|------|-----|---|
| 駅名 | 文字列 | ○ | 駅名 | `渋谷`, `新宿` |
| 番線 | 整数 | ○ | 番線番号 | `1`, `2`, `3` |
| 軌道回路1 | 文字列 | ○ | 軌道回路ID (1つ目) | `SB-01` |
| 軌道回路2 | 文字列 | △ | 軌道回路ID (2つ目) | `SB-02` |
| 軌道回路3 | 文字列 | △ | 軌道回路ID (3つ目) | `SB-03` |
| ... | ... | △ | 軌道回路ID (可変長) | ... |

**注意**: 軌道回路カラムは可変長で、最大数に制限はありません。空白セルはスキップされます。

#### 2.2.3 データ例

```csv
駅名,番線,軌道回路1,軌道回路2,軌道回路3,軌道回路4
渋谷,1,SB-01,SB-02,SB-03,
渋谷,2,SB-04,SB-05,,
新宿,1,SJ-01,SJ-02,SJ-03,SJ-04
新宿,2,SJ-05,SJ-06,SJ-07,
新宿,3,SJ-08,SJ-09,,
```

#### 2.2.4 在線判定ロジック

**判定方式**: 軌道回路セットの完全一致

1. APIから在線軌道回路リストを取得
2. 在線軌道回路リストを `HashSet<string>` に変換
3. 駅・番線定義の各エントリーの軌道回路セットと比較
4. `HashSet.SetEquals()` で完全一致する場合、その駅・番線に在線していると判定

**例**:

```csharp
// 在線軌道回路: [SB-01, SB-02, SB-03]
var occupiedTracks = new HashSet<string> { "SB-01", "SB-02", "SB-03" };

// 渋谷1番線: [SB-01, SB-02, SB-03]
var shibuya1Tracks = new HashSet<string> { "SB-01", "SB-02", "SB-03" };

// 完全一致 → 渋谷1番線に在線
if (occupiedTracks.SetEquals(shibuya1Tracks))
{
    // 在線判定成功
}
```

#### 2.2.5 バリデーションルール

| ルール | エラー処理 |
|--------|-----------|
| 駅名が空欄 | エラーメッセージ表示、該当行をスキップ |
| 番線が空欄または数値でない | エラーメッセージ表示、該当行をスキップ |
| 軌道回路1が空欄 | エラーメッセージ表示、該当行をスキップ |
| CSV形式が不正 | エラーメッセージ表示、読み込み中止 |
| 重複する駅・番線エントリー | 警告メッセージ、最後のエントリーを使用 |

---

## 3. JSON仕様

### 3.1 アプリケーション設定ファイル (appsettings.json)

#### 3.1.1 ファイル仕様

| 項目 | 値 |
|-----|---|
| ファイル名 | `appsettings.json` (固定) |
| エンコーディング | UTF-8 (BOMなし) |
| 改行コード | LF (推奨) または CRLF |
| フォーマット | JSON |

#### 3.1.2 スキーマ定義

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "ApiEndpoint": {
      "type": "string",
      "description": "Traincrew API エンドポイントURL",
      "default": "http://localhost:8080"
    },
    "CurrentProfile": {
      "type": "string",
      "description": "現在使用中のプロファイルCSVファイルパス",
      "default": "profiles/profile_default.csv"
    },
    "StationDefinition": {
      "type": "string",
      "description": "駅・番線定義CSVファイルパス",
      "default": "stations/stations.csv"
    },
    "TopmostMode": {
      "type": "string",
      "enum": ["Always", "PlayingOnly", "AtStationOnly", "None"],
      "description": "最前面表示モード",
      "default": "PlayingOnly"
    },
    "ShowOnPause": {
      "type": "boolean",
      "description": "ポーズ時も最前面に表示するか",
      "default": true
    },
    "Volume": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "音量 (0.0 ~ 1.0)",
      "default": 0.8
    },
    "WindowPosition": {
      "type": "object",
      "properties": {
        "X": { "type": "integer", "default": 100 },
        "Y": { "type": "integer", "default": 100 }
      },
      "description": "ウィンドウ位置",
      "required": ["X", "Y"]
    },
    "WindowSize": {
      "type": "object",
      "properties": {
        "Width": { "type": "integer", "default": 300 },
        "Height": { "type": "integer", "default": 300 }
      },
      "description": "ウィンドウサイズ",
      "required": ["Width", "Height"]
    },
    "InputKey": {
      "type": "string",
      "description": "入力キー",
      "default": "Space"
    },
    "LogLevel": {
      "type": "string",
      "enum": ["Info", "Warn", "Error"],
      "description": "ログレベル",
      "default": "Info"
    }
  },
  "required": ["ApiEndpoint", "CurrentProfile", "StationDefinition"]
}
```

#### 3.1.3 設定項目詳細

| 項目 | データ型 | 必須 | デフォルト値 | 説明 |
|-----|---------|------|------------|------|
| ApiEndpoint | 文字列 | ○ | `http://localhost:8080` | Traincrew APIのエンドポイントURL |
| CurrentProfile | 文字列 | ○ | `profiles/profile_default.csv` | 使用する音声プロファイルのパス |
| StationDefinition | 文字列 | ○ | `stations/stations.csv` | 駅・番線定義CSVのパス |
| TopmostMode | 文字列 | ○ | `PlayingOnly` | 最前面表示モード (`Always`, `PlayingOnly`, `AtStationOnly`, `None`) |
| ShowOnPause | 真偽値 | ○ | `true` | ポーズ時も最前面表示するか |
| Volume | 数値 | ○ | `0.8` | 音量 (0.0 ~ 1.0) |
| WindowPosition | オブジェクト | ○ | `{"X": 100, "Y": 100}` | ウィンドウ位置 |
| WindowSize | オブジェクト | ○ | `{"Width": 300, "Height": 300}` | ウィンドウサイズ |
| InputKey | 文字列 | ○ | `Space` | 入力キー (`Space`, `Enter`など) |
| LogLevel | 文字列 | ○ | `Info` | ログレベル (`Info`, `Warn`, `Error`) |

#### 3.1.4 データ例

```json
{
  "ApiEndpoint": "http://localhost:8080",
  "CurrentProfile": "profiles/profile_default.csv",
  "StationDefinition": "stations/stations.csv",
  "TopmostMode": "PlayingOnly",
  "ShowOnPause": true,
  "Volume": 0.8,
  "WindowPosition": {
    "X": 100,
    "Y": 100
  },
  "WindowSize": {
    "Width": 300,
    "Height": 300
  },
  "InputKey": "Space",
  "LogLevel": "Info"
}
```

#### 3.1.5 バリデーションルール

| ルール | エラー処理 |
|--------|-----------|
| ファイルが存在しない | デフォルト設定を使用、新規作成 |
| JSON形式が不正 | エラーメッセージ表示、デフォルト設定を使用 |
| 必須項目が不足 | デフォルト値で補完 |
| Volumeが範囲外 (0.0 ~ 1.0) | 0.0 または 1.0 にクランプ |
| TopmostModeが不正な値 | デフォルト値 (`PlayingOnly`) を使用 |

---

## 4. ログファイル仕様

### 4.1 ファイル仕様

| 項目 | 値 |
|-----|---|
| ファイル名 | `YYYYMMDDhhmmss.txt` (例: `20251011120000.txt`) |
| 保存先 | `log/` ディレクトリ |
| エンコーディング | UTF-8 (BOMなし) |
| 改行コード | CRLF (Windows標準) |

### 4.2 ログフォーマット

```
[YYYY-MM-DD HH:mm:ss.fff] [LEVEL] メッセージ
例外スタックトレース (エラー時のみ)
```

**例**:

```
[2025-10-11 12:00:00.123] [INFO] Application started
[2025-10-11 12:00:01.456] [INFO] Loading audio profile: profiles/profile_default.csv
[2025-10-11 12:00:01.789] [INFO] Loaded 55 audio entries
[2025-10-11 12:00:02.012] [INFO] Loading station definition: stations/stations.csv
[2025-10-11 12:00:02.345] [INFO] Loaded 24 station platforms
[2025-10-11 12:00:05.678] [INFO] Button pressed
[2025-10-11 12:00:05.679] [INFO] Mode switch: VehicleMode -> StationMode
[2025-10-11 12:00:05.680] [INFO] Playing station melody: sounds/station/shibuya_1.mp3
[2025-10-11 12:00:10.123] [INFO] Playing station door closing: sounds/door/door_odd.mp3
[2025-10-11 12:00:13.456] [WARN] Station melody not found: 原宿 1番線 (using vehicle melody as fallback)
[2025-10-11 12:00:15.789] [ERROR] Failed to play audio: sounds/missing.mp3
System.IO.FileNotFoundException: Could not find file 'C:\...\sounds\missing.mp3'.
   at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)
   ...
```

### 4.3 ログレベル

| レベル | 説明 | 使用例 |
|-------|-----|--------|
| INFO | 通常の動作情報 | アプリ起動、プロファイル読み込み、モード切替、音声再生 |
| WARN | 警告 (動作は継続) | フォールバック動作、軽微なエラー |
| ERROR | エラー (動作に影響あり) | ファイル読み込み失敗、API接続失敗、例外発生 |

### 4.4 ログローテーション

- **方式**: 起動時に新規ログファイル作成
- **世代管理**: なし (手動削除)
- **将来拡張**: 古いログファイルの自動削除機能 (30日以上前のログを削除)

---

## 5. データ関連図

### 5.1 データフロー図

```
┌─────────────────┐
│ appsettings.json│
└────────┬────────┘
         │ 起動時読み込み
         ▼
┌─────────────────┐
│ SettingsManager │
└────────┬────────┘
         │
         ├─────────────────────────────────┐
         │                                 │
         ▼                                 ▼
┌──────────────────┐            ┌──────────────────┐
│ profile_*.csv    │            │ stations.csv     │
└────────┬─────────┘            └────────┬─────────┘
         │                                 │
         │ ProfileLoader                   │ StationRepository
         ▼                                 ▼
┌──────────────────┐            ┌──────────────────┐
│ AudioRepository  │            │ StationRepository│
└────────┬─────────┘            └────────┬─────────┘
         │                                 │
         └─────────┬───────────────────────┘
                   │
                   ▼
           ┌───────────────┐
           │  ModeManager  │
           └───────────────┘
```

### 5.2 CSVデータとオブジェクトのマッピング

#### 5.2.1 音声プロファイルCSV → AudioKey

```
CSV行:
種別: "駅メロディー", 駅名: "渋谷", 番線: 1, 上下: "", ファイルパス: "sounds/shibuya_1.mp3"

↓ 変換

AudioKey:
{
  Type: AudioType.StationMelody,
  StationName: "渋谷",
  Platform: 1,
  IsOdd: null,
  Direction: null
}

Dictionary<AudioKey, string>:
[AudioKey] -> "sounds/shibuya_1.mp3"
```

#### 5.2.2 駅・番線定義CSV → StationPlatform

```
CSV行:
駅名: "渋谷", 番線: 1, 軌道回路1: "SB-01", 軌道回路2: "SB-02", 軌道回路3: "SB-03"

↓ 変換

StationPlatform:
{
  StationName: "渋谷",
  Platform: 1
}

HashSet<string>:
{ "SB-01", "SB-02", "SB-03" }

Dictionary<StationPlatform, HashSet<string>>:
[StationPlatform] -> { "SB-01", "SB-02", "SB-03" }
```

---

## 6. デフォルトデータ

### 6.1 デフォルト音声プロファイル (profile_default.csv)

```csv
種別,駅名,番線,上下,ファイルパス
車両メロディー,,,上り,sounds/vehicle/melody_up.mp3
車両メロディー,,,下り,sounds/vehicle/melody_down.mp3
車両ドア締まります,,,,sounds/door/door_train.mp3
駅ドア締まります,,,奇数,sounds/door/door_odd.mp3
駅ドア締まります,,,偶数,sounds/door/door_even.mp3
```

**注意**: このデフォルトプロファイルには駅メロディーは含まれていません。ユーザーが自身で追加する必要があります。

### 6.2 デフォルト駅定義 (stations.csv)

```csv
駅名,番線,軌道回路1,軌道回路2,軌道回路3
サンプル駅,1,SAMPLE-01,SAMPLE-02,
サンプル駅,2,SAMPLE-03,SAMPLE-04,
```

**注意**: これはサンプルです。実際の駅・番線定義はユーザーが自身で作成する必要があります。

---

## 7. データ整合性

### 7.1 参照整合性チェック

| チェック項目 | チェックタイミング | エラー処理 |
|-----------|------------------|-----------|
| プロファイルCSVのファイルパス存在確認 | プロファイル読み込み時 | エラーメッセージ表示、読み込み中止 |
| 駅定義CSVの重複チェック | 駅定義読み込み時 | 警告メッセージ、最後のエントリーを使用 |
| 音声ファイルの再生可能性チェック | 音声再生時 | エラーログ出力、無音で継続 |
| 設定ファイルのパス存在確認 | 起動時 | デフォルト値使用、新規作成 |

### 7.2 データ更新

| データ | 更新方法 | 反映タイミング |
|-------|---------|--------------|
| 音声プロファイルCSV | 設定画面で別のプロファイルを選択 | 即座に反映 |
| 駅定義CSV | 設定画面でファイルパスを変更 | 保存ボタン押下後、再読み込み |
| アプリケーション設定 | 設定画面で変更 | 保存ボタン押下後、即座に反映 |
| ログファイル | 自動生成 | リアルタイム書き込み |

---

## 8. データバックアップ

### 8.1 バックアップ対象

- `appsettings.json`
- `profiles/*.csv`
- `stations/*.csv`
- `log/*.txt` (任意)

### 8.2 バックアップ方法

手動バックアップ (将来拡張でエクスポート機能を実装予定)

---

## 9. データ移行

### 9.1 バージョン間のデータ移行

将来のバージョンアップ時にデータ形式が変更される場合、以下の方針で対応します。

- **後方互換性**: 可能な限り、旧バージョンのデータファイルをそのまま読み込めるようにする
- **マイグレーション**: データ形式変更時は、起動時に自動マイグレーション実行
- **マイグレーションログ**: マイグレーション内容をログファイルに記録

---

## 10. データセキュリティ

### 10.1 セキュリティ対策

| 項目 | 対策 |
|-----|-----|
| パストラバーサル対策 | ファイルパス読み込み時に相対パスを検証 |
| CSVインジェクション対策 | CSVライブラリ (CsvHelper) を使用した安全な読み込み |
| ファイル拡張子チェック | 音声ファイル読み込み時に拡張子を検証 |
| 権限チェック | ファイル読み書き時に適切な権限を確認 |

---

## 11. データ容量見積もり

### 11.1 想定データサイズ

| データ | サイズ | 備考 |
|-------|-------|-----|
| appsettings.json | < 1 KB | 設定項目が少ないため |
| profile_*.csv | < 10 KB | 100エントリー程度を想定 |
| stations.csv | < 5 KB | 50駅×2番線 = 100エントリー程度を想定 |
| ログファイル (1日分) | < 1 MB | 通常使用時 |
| 音声ファイル (1ファイル) | 100 KB ~ 5 MB | MP3形式、10秒 ~ 2分程度 |

### 11.2 総容量見積もり

- アプリケーション本体: 5 ~ 10 MB
- 設定ファイル: < 1 MB
- 音声ファイル: 100 MB ~ 1 GB (ユーザー依存)
- ログファイル: 10 ~ 100 MB (30日分)

**合計**: 200 MB ~ 1.5 GB (音声ファイル次第)

---

**改訂履歴**

| バージョン | 日付 | 改訂者 | 改訂内容 |
|-----------|------|--------|----------|
| 1.0 | 2025-10-11 |  | 初版作成 |
